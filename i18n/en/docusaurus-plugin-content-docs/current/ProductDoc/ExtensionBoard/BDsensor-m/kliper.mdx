---
sidebar_position: 3
sidebar_label: Using Klipper
---





# Installing **BDsensor-m**

## Connect the sensor cable to the EXP1 port on the mainboard
    * If the sensor cable is not long enough, use the extension cable from the packaging
    * The CKL and SDA lines of BDsensor-m can be connected to any GPIO pins on the board. You can also connect the BD sensor cable directly to the Bltouch port, for example:

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Input)
    GND      -->     GND
    Zmin     -->     SDA    (Input/Output) 
    ```

    * Some pins in the mainboard connectors might not be directly connected to the MCU's GPIOs (e.g., they might have filtering capacitors or be isolated through MOSFETs, diodes, or optocouplers, but if isolated through resistors or pull-up/pull-down resistors, they can be used). Therefore, they cannot be used with `BDsensor-m` and the firmware will report a connection error. For example:
    * Fan and heater connectors are isolated through MOSFETs,
    * Connectors for temperature thermistors and endstops/probes in some boards are usually connected to GND through filtering capacitors.

1. Install the BD sensor near the hotend as shown in the picture. [STL of mount](https://www.thingiverse.com/thing:6098131), [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/BDsensor-m/img/jxcs_webp.webp').default} size="100%" align="left" />


## Install the patch into the Klipper firmware

    * Abandon any previously modified Klipper files and update Klipper

        ```bash
        cd
        cd ~/klipper
        git checkout .
        git pull
        ```

    * Clone the latest code for the BD sensor

        ```bash
        cd && git clone https://github.com/markniu/Bed_Distance_sensor.git
        ```

    * Install

        ```bash
        cd  ~/Bed_Distance_sensor/klipper/
        ./install_BDsensor.sh
        ```

    * Compile the firmware

        ```bash
        cd ~/klipper/
        make menuconfig
        make clean
        make
        ```

    * Flash the firmware to the mainboard connected to the BD sensor

## If your printer runs Moonraker, add the following section to moonraker.conf, then you can update BDsensor with one click through the web page or KlipperScreen.

    ```bash
    [update_manager BDsensor]
    type: git_repo
    primary_branch: new
    channel: dev
    path: ~/Bed_Distance_sensor
    origin: https://github.com/markniu/Bed_Distance_sensor.git
    install_script: ./klipper/install_BDsensor.sh
    is_system_service: False
    managed_services: klipper
    info_tags:
    desc=Bed Distance Sensor
    ```

## Edit printer.cfg

    * Copy this section into your **printer.cfg** and edit `sda_pin` and `scl_pin` in `[BDsensor]`, and don't forget to disable other probe sections like **BLtouch**. You can connect the BD sensor to either the mainboard or the toolhead CAN module.
    * In `[BDsensor]`, change `speed` to 0.8. This only applies to the z tilt and PROBE_ACCURACY commands. The lower the value, the higher the accuracy during probing because the MCU reads the BD sensor in the main loop, not in real-time like a regular endstop. `[BDsensor]`
    * To use the BD sensor as a limit switch when homing Z-axis, change `endstop_pin` in `[stepper_z]` to `endstop_pin: probe:z_virtual_endstop`
    * Make sure **printer.cfg** has `[safe_z_home]` 
    * Change the `max_deviation` value in `[bed_mesh]` and `[z_tilt]` or `[quad_gantry_level]` to 1 (recommended 0.7-1.0mm); Klipper's default is 5mm, otherwise, it might exceed the sensor's range
    * **Nozzle height should only be set in `z_adjust:`, positive values bring it closer to the bed, negative values move it away. Other settings for nozzle height might cause bugs**
    * To enable fast bed scanning, remove the `#` before `no_stop_probe:true`
    * Here is an example configuration:

        ```cfg
        [BDsensor] 
        scl_pin:PC6  # Servo signal port
        sda_pin:PC3  # Limit signal port
        delay: 20 # 20us per pulse, this value should be >=20 but must be below 50
        z_offset:0 # this `z_offset` must be set to 0. 
        z_adjust:0.0 # z axis adjustment, replace the z_offset function. within -0.3 to 0.3mm
        x_offset: -34
        y_offset: 0
        #no_stop_probe:true # enable this for fast probe, the toolhead will not stop at the probe point.
        position_endstop: 0.8 # the Z axis will stop at this position (mm) while homing z, recommend value is 0.4~1.0
        #speed:0.8 # this speed only works for the z tilt and PROBE_ACCURACY command.

        [stepper_z]
        endstop_pin: probe:z_virtual_endstop 
        #position_endstop: 0.5
        homing_speed: 5
        second_homing_speed: 0.8

        [bed_mesh]
        speed: 200
        horizontal_move_z:1
        algorithm: bicubic

        [quad_gantry_level]
        horizontal_move_z:1

        ```

## After installation, check by sending the following G-code commands:

    ```bash
    M102   S-1     # Read sensor information
    M102   S-2     # Read a distance value
    ```

## Check Connection

    * Send `M102 S-1` through the **console**; here is an example of the return message. If it returns blank or another string, check the connection and wire order:

        ```bash
        Send: M102 S-1
        Recv: V1.0 pandapi3d.com
        ```

## Calibration

    * Clean the nozzle, then move the Z-axis through the console until the nozzle just touches the bed (BDsensor-m will use this position as the zero point, so no `z_offset` is needed, which is why the value in the [BDsensor-m] section is 0)
    * Send the G-code command `M102 S-6` through the **console**. The printer will move the Z-axis up by 0.1mm slowly each time until it reaches 4mm. Do not run M102 S-6 before installing the sensor, and do not turn off the printer during calibration, otherwise, the old calibration data will be lost. If this happens, simply recalibrate.
    * After calibration, you can check if the BD sensor has been successfully calibrated with `M102 S-5`, which will return the raw calibration data stored in the BD sensor.

**Notes**:

* The best homing speed for the Z-axis is 5

* If M102 S-5 returns a first raw calibration data greater than 400, it means the sensor is installed too high and needs to be reinstalled closer to the bed; the recommended value for the first data point is 100. Also, ensure the second data point is at least 10 higher than the first.

  * FAQ: What does it mean if the calibration data starts with 1, the second value is 9, and the third is 24?

  * This means the resolution between 0-0.1mm is only 9, while the resolution between 0.1-0.2mm is 15. Therefore, it's recommended to recalibrate to get a first resolution of 0-0.1mm greater than 10.

* Don't forget to adjust the Z-axis height after running G28 or for the commands `Z_tilt` and `quad_gantry_level`.

* The section names must be correctly capitalized, otherwise, Klipper will report `Unknown pin chip name 'probe'`.