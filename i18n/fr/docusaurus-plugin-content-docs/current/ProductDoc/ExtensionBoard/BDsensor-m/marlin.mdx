---
sidebar_position: 3
sidebar_label: Utilisation de Marlin
---

# Installation du **BDsensor-m-m**

## Connecter le câble du capteur à l'interface EXP1 de la carte mère
    * Si le câble du capteur est trop court, vous pouvez utiliser le câble de rallonge fourni.
    * Les fils CKL et SDA du BDsensor-m-m peuvent être connectés à n'importe quelle broche GPIO de la carte. Vous pouvez également connecter directement le câble du capteur BD au port Bltouch, par exemple :

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Input)
    GND      -->     GND
    Zmin     -->     SDA    (Input/Output) 
    ```

    * En raison du fait que certaines broches des connecteurs de la carte mère peuvent ne pas être directement connectées aux GPIO du MCU (par exemple, elles peuvent avoir des condensateurs de filtrage ou être isolées par des MOSFET, des diodes ou des coupleurs optiques, mais si elles sont isolées par des résistances ou des résistances de pull-up/pull-down, elles peuvent être utilisées), elles ne peuvent pas être utilisées avec le BDsensor-m. Et le firmware signalera une erreur de connexion. Par exemple :

    * Les connecteurs des ventilateurs et des chauffages sont isolés par des MOSFET,
    * Certains connecteurs de la carte utilisés pour les thermistances de température et les fins de course/les sondes sont généralement connectés à GND via des condensateurs de filtrage,

1. Comme illustré ci-dessous, installez le capteur BD à proximité de la buse chaude. [STL du support](https://www.thingiverse.com/thing:6098131), [STL_mount_VzBot_Goliath_short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/BDsensor-m/img/jxcs_webp.webp').default} size="100%" align="left" />



## Installer le patch dans le firmware Marlin

    Le capteur BD a été intégré à Marlin2.1.x (depuis le 27/08/2022),

    Vous pouvez télécharger la version publiée. Cependant, il est maintenant recommandé de télécharger la dernière version de correction d'erreurs : https://github.com/MarlinFirmware/Marlin

    Vous aurez besoin de modifier le fichier de configuration et le fichier de broches.

### Éditer le fichier configuration.h

1. Activer BD_SENSOR

    Décommenter

    ```bash
    #define BD_SENSOR
    #define Z_SAFE_HOMING
    #define BD_SENSOR_PROBE_NO_STOP // ajouter cette nouvelle ligne pour un nivellement de lit rapide sans arrêt de la buse,
    ```

    Seul `BD_SENSOR_PROBE_NO_STOP`

    Dernière correction d'erreurs Marlin : https://github.com/MarlinFirmware/Marlin

    Description : https://github.com/MarlinFirmware/Marlin/pull/25847

2. Utiliser la sonde pour le homing

    Assurez-vous que Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN est désactivé, et activez `USE_PROBE_FOR_Z_HOMING` comme suit :

    ```bash
    //#define Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN
    // Force the use of the probe for Z-axis homing
    #define USE_PROBE_FOR_Z_HOMING
    ```

3. Ralentir la deuxième vitesse de homing Z

    ```bash
    #define Z_PROBE_FEEDRATE_SLOW (Z_PROBE_FEEDRATE_FAST / 16)
    ```

    Ici, nous devons ralentir la vitesse de homing de la bosse et la vitesse de homing Z, car les données lues par le processus BDsensor-m ne sont pas aussi en temps réel que celles d'un fin de course normal.

### Éditer le fichier Configuration_adv.h

    Activer `#define BABYSTEPPING` pour activer la fonction de nivellement en temps réel

    ```bash
    #define HOMING_BUMP_DIVISOR { 2, 2, 8 }       // Diviseur de vitesse de rebond de homing (Divise la vitesse de homing)
    ```

### Éditer le fichier pins_boardname.h

    Configurez les broches SDA et SCL du BDsensor-m dans le fichier pins_boardname.h en ajoutant les 3 lignes suivantes (par exemple) : `pins_PANDA_PI_V29.h`

        ```bash
        #define  I2C_BD_SDA_PIN    PC6   // Veuillez modifier par le numéro réel auquel le fil SDA est connecté sur votre carte mère
        #define  I2C_BD_SCL_PIN    PB2   // Veuillez modifier par le numéro réel auquel le fil SLK est connecté sur votre carte mère
        #define  I2C_BD_DELAY  20      // La valeur par défaut est 20, devrait être dans la plage [20,50].
        ```

    Si vous souhaitez effectuer un nivellement de lit automatique avant l'impression comme avec un BLtouch (G29), décommenter

        ```bash
        #define AUTO_BED_LEVELING_BILINEAR
        ```

    et éditer les valeurs suivantes

        ```bash
        #define Z_CLEARANCE_DEPLOY_PROBE   0 // Dégagement Z pour le déploiement/repli de la sonde
        #define Z_CLEARANCE_BETWEEN_PROBES  1 // Dégagement Z entre les points de la sonde
        #define Z_CLEARANCE_MULTI_PROBE     1 // Dégagement Z entre plusieurs sondages
        ```



## Afficher la valeur du capteur BD sur l'écran LCD

    * Pour les imprimantes équipées d'un affichage d'état (supportant la commande gcode M117), comme LCD12864 ou certains écrans UART, comme ender3V2 ...

## Calibration

    1. Nettoyez la buse, puis déplacez l'axe Z via la console jusqu'à ce que la buse touche légèrement le lit (le BDsensor-m utilisera cette position comme point zéro, donc aucun z_offset n'est nécessaire, nous définissons la valeur à 0).
    2. Envoyez la commande gcode `M102 S-6`, l'imprimante montera lentement l'axe Z de 0.1mm à chaque fois jusqu'à atteindre 4mm. Ne pas exécuter M102 S-6 avant l'installation du capteur, et ne pas éteindre l'imprimante pendant la calibration, sinon les anciennes données de calibration seront supprimées. Dans ce cas, recalibrez simplement.

    3. Vous pouvez envoyer `M102 S-5` pour vérifier si le capteur BD a été calibré avec succès, cela retournera les données brutes de calibration stockées dans le capteur BD.

    Il existe également un outil de calibration qui peut faire cela : https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip ![img](https://raw.githubusercontent.com/markniu/Bed_Distance_sensor/main/doc/images/Read.jpg)

    Note : Une valeur de données de 1015 ou > 1010 indique que le capteur est hors de portée. Si les 5 premiers points (0~0.5mm) ou plus sont dans la plage de 0 à 1000, et que la valeur delta augmente de >=10, cela signifie que la calibration a réussi. Comme illustré sur le graphique ci-dessus.

    Si la première donnée brute de calibration retournée par M102 S-5 est supérieure à 400, cela signifie que le capteur est installé trop haut et doit être réinstallé à une position plus proche du lit. Assurez-vous également que la deuxième donnée est supérieure de plus de 10 à la première.

## Test et impression

    Menu de nivellement du lit

    Nivellement automatique du lit

## Il y a deux méthodes pour le nivellement automatique du lit :

    **1. Utiliser M102 pour le nivellement en temps réel des premières couches**

        Nous pouvons facilement activer ou désactiver ce niveau automatique en envoyant des commandes gcode ou en ajoutant des gcodes dans le fichier gcode.

        Pour activer le nivellement du lit dans Cura, ajoutez le gcode M102 juste en dessous du gcode G102 (homing de tous les axes) dans la section "G-code de démarrage" des paramètres de la machine. Par exemple, sous G28, cela signifie qu'il ne nivellera le lit que lorsque la hauteur Z est inférieure à 0.2mm. `M102 S2`

        Envoyer ou ajouter l'utilisation du capteur BD pour désactiver le nivellement du lit, à noter que par défaut, il est désactivé. `M102 S0` `G28` `M18`

        ```bash
        M102   S-1     // Lire les informations du capteur, et nous pouvons l'utiliser pour vérifier la connexion.
        M102   S-2     // Lire la valeur de distance actuelle
        M102   S-5     // Lire les données brutes de calibration
        M102   S-6     // Démarrer la calibration, assurez-vous que la buse vient juste de toucher le lit, puis l'imprimante redémarre. Ne pas homing l'axe Z avant cela.
        M102   S4      // Définir la valeur de hauteur Z ajustable, par exemple, M102 S4 signifie qu'il ajustera lorsque la hauteur Z <=0.4mm, désactiver avec M102 S0.
        ```

    **2. G29 Nivellement automatique du lit**

        Une autre méthode de nivellement automatique du lit est comme avec le G29 de BLtouch, il suffit d'ajouter une ligne G28 en dessous de G29.

        [Vidéo d'installation](https://www.pandapi3d.com/post/install-bed-distance-sensor-video)

        [Vidéo d'installation de Chris' Basement](https://youtu.be/VLUfvkO2NFc?si=PF_6nhw39KhHBhcj)

### Vérifier le fin de course Z `M119`

    Ne homing pas Z avant de vérifier cette étape, sinon la buse pourrait heurter le lit de l'imprimante.

    Voici le message de retour après l'envoi de la commande M119 (rapport de l'état des fins de course).

    ```bash
    Send: M119
    Recv: x:ouvert y:ouvert z:ouvert
    ```

    Si z min n'est pas ouvert, vérifiez votre configuration. `#define Z_MAX_ENDSTOP_HIT_STATE HIGH`

    - Assurez-vous que le moteur Z est désactivé/déverrouillé
    - Déplacez l'axe Z à la main vers le bas jusqu'à ce que la buse touche le lit
    - Envoyez `M102 S-2`, la valeur retournée devrait être 0.00mm, puis renvoyez M119, vous pourrez voir que le fin de course z est maintenant déclenché.

    ```bash
    Send: M119
    Recv: x:ouvert y:ouvert z:DÉCLENCHÉ
    ```

    ### Vérifier la connexion

    Vérifiez la connexion avec `M102 S-1`. Voici un exemple de message de retour, vérifiez la connexion et l'ordre des fils s'ils retournent une chaîne vide ou autre.

    ```bash
    Send: M102 S-1
    Recv: V1.0 pandapi3d.com
    ```



##  Si toutes les étapes ci-dessus sont correctes, vous pouvez maintenant homing l'axe z.

