---
sidebar_position: 3
sidebar_label: Utilisation de Klipper
---





# Installation du **BDsensor-m**

## Connecter le câble du capteur à l'interface EXP1 de la carte mère
    * Si le câble du capteur est trop court, utilisez le câble d'extension fourni dans l'emballage.
    * Les lignes CKL et SDA du BDsensor-m peuvent être connectées à n'importe quelle broche GPIO de la carte. Vous pouvez également connecter directement le câble du capteur BD au port Bltouch, par exemple :

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Input)
    GND      -->     GND
    Zmin     -->     SDA    (Input/Output) 
    ```

    * En raison de certaines broches dans le connecteur de la carte mère qui peuvent ne pas être directement connectées aux gpios de l'MCU (par exemple, elles peuvent avoir des condensateurs de filtrage ou être isolées par MOSFET, diodes ou coupleurs optiques, mais si elles sont isolées par des résistances ou des résistances pull-up/pull-down, elles peuvent également être utilisées), elles ne peuvent pas être utilisées avec le `BDsensor-m`. Et le firmware signalera une erreur de connexion. Par exemple :
    * Les connecteurs des ventilateurs et des radiateurs sont isolés par MOSFET,
    * Certains connecteurs pour thermistances de température et fins de course/sondes sont généralement connectés à la GND via des condensateurs de filtrage dans certaines cartes,

1. Comme illustré ci-dessous, installez le capteur BD près de l'extrémité chaude. [STL du support](https://www.thingiverse.com/thing:6098131), [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/BDsensor-m/img/jxcs_webp.webp').default} size="100%" align="left" />


## Installation du patch dans le firmware Klipper

    * Abandonnez les fichiers Klipper modifiés précédemment et mettez à jour Klipper

        ```bash
        cd
        cd ~/klipper
        git checkout .
        git pull
        ```

    * Clonez le code le plus récent du capteur BD

        ```bash
        cd && git clone https://github.com/markniu/Bed_Distance_sensor.git
        ```

    * Installation

        ```bash
        cd  ~/Bed_Distance_sensor/klipper/
        ./install_BDsensor.sh
        ```

    * Compilation du firmware

        ```bash
        cd ~/klipper/
        make menuconfig
        make clean
        make
        ```

    * Flashez le firmware sur la carte mère connectée au BDsensor

## Si votre imprimante fonctionne avec Moonraker, ajoutez la section suivante à moonraker.conf, puis vous pourrez mettre à jour le BDsensor en un clic via la page web ou klipperscreen.

    ```bash
    [update_manager BDsensor]
    type: git_repo
    primary_branch: new
    channel: dev
    path: ~/Bed_Distance_sensor
    origin: https://github.com/markniu/Bed_Distance_sensor.git
    install_script: ./klipper/install_BDsensor.sh
    is_system_service: False
    managed_services: klipper
    info_tags:
    desc=Bed Distance Sensor
    ```

## Édition de printer.cfg

    * Copiez cette section dans votre **printer.cfg** et modifiez `sda_pin` et `scl_pin` de `[BDsensor]`, et n'oubliez pas de désactiver les autres sections de sondes comme **BLtouch**. Vous pouvez connecter le capteur BD sur la carte mère ou sur un module CAN de la tête d'outil,
    * Dans `[BDsensor]`, modifiez `speed` à 0.8. Cela ne s'applique qu'aux commandes Z_tilt et PROBE_ACCURACY. Une valeur plus petite signifie une précision plus élevée lors de la détection, car le MCU lit le capteur BD dans le circuit principal lors du retour à zéro, ce qui n'est pas en temps réel comme un fin de course normal. `[BDsensor]`
    * Pour utiliser le capteur BD comme fin de course lors du retour à zéro de l'axe Z, modifiez `endstop_pin` dans `[stepper_z]` à `endstop_pin: probe:z_virtual_endstop`
    * Assurez-vous que **printer.cfg** contient `[safe_z_home]`
    * Modifiez la valeur de `z_tilt` ou `quad_gantry_level` dans `[bed_mesh]` et `[z_tilt]` ou `[quad_gantry_level]` à 1 (suggéré entre 0.7 et 1.0mm), sinon, cela pourrait dépasser la portée du capteur
    * **La hauteur de la buse doit être ajustée uniquement via `z_adjust:`, un nombre positif rapproche la buse du lit, un nombre négatif l'éloigne, d'autres réglages de hauteur de buse peuvent causer des bugs**
    * Pour activer le balayage rapide du lit, supprimez le # devant `no_stop_probe:true`
    * Voici un exemple de configuration :

        ```cfg
        [BDsensor] 
        scl_pin:PC6  # Port de signal du servomoteur
        sda_pin:PC3  # Port de signal de fin de course
        delay: 20 # 20us par impulsion, cette valeur doit être >=20 mais inférieure à 50
        z_offset:0 # cette `z_offset` doit être réglée à 0. 
        z_adjust:0.0 # ajustement de l'axe Z, remplace la fonction z_offset. entre -0.3 et 0.3mm
        x_offset: -34
        y_offset: 0
        #no_stop_probe:true # activez cela pour une sonde rapide, la tête d'outil ne s'arrêtera pas au point de sonde.
        position_endstop: 0.8 # l'axe Z s'arrêtera à cette position (mm) lors du retour à zéro, valeur recommandée entre 0.4 et 1.0
        #speed:0.8 # cette vitesse ne fonctionne que pour les commandes z tilt et PROBE_ACCURACY.

        [stepper_z]
        endstop_pin: probe:z_virtual_endstop 
        #position_endstop: 0.5
        homing_speed: 5
        second_homing_speed: 0.8

        [bed_mesh]
        speed: 200
        horizontal_move_z:1
        algorithm: bicubic

        [quad_gantry_level]
        horizontal_move_z:1

        ```

## Après l'installation, vérifiez en envoyant les commandes G-code suivantes

    ```bash
    M102   S-1     # Lecture des informations du capteur
    M102   S-2     # Lecture d'une valeur de distance
    ```

## Vérification de la connexion

    * Envoyez `M102 S-1` via la **console**, voici un exemple de message de retour, si le retour est vide ou contient une autre chaîne, vérifiez la connexion et l'ordre des fils

        ```bash
        Send: M102 S-1
        Recv: V1.0 pandapi3d.com
        ```

## Calibrage

    * Nettoyez la buse, puis déplacez l'axe Z via la console jusqu'à ce que la buse touche à peine le lit (le BDsensor-m utilisera cette position comme position zéro, donc pas besoin de `z_offset`, c'est pourquoi la valeur est 0 dans la section [BDsensor-m])
    * Envoyez la commande G-code `M102 S-6` via la **console**, l'imprimante montera l'axe Z de 0.1mm à chaque fois jusqu'à atteindre 4mm. Ne lancez pas M102 S-6 avant d'avoir installé le capteur, et ne coupez pas l'alimentation de l'imprimante pendant le calibrage, sinon les anciennes données de calibrage seront effacées. Dans ce cas, recalibrez simplement.
    * Ensuite, vous pouvez vérifier si le capteur BD a été correctement calibré avec `M102 S-5`, ce qui retournera les données de calibrage brutes stockées dans le capteur BD.

**Remarques**:

* La vitesse de retour à zéro de l'axe Z devrait être de 5.

* Si la première donnée brute de M102 S-5 est supérieure à 400, cela signifie que le capteur est installé trop haut et doit être réinstallé plus près du lit, la valeur recommandée pour la première donnée est de 100. Assurez-vous également que la deuxième donnée est supérieure de 10 ou plus à la première.

  * FAQ : Si les données de calibrage commencent par 1, la deuxième valeur est 9, et la troisième est 24, qu'est-ce que cela signifie ?

  * Cela signifie que la résolution entre 0 et 0.1 mm est de 9, tandis que la résolution entre 0.1 et 0.2 mm est de 15. Il est donc recommandé de recalibrer pour que la première résolution soit supérieure à 10.

* N'oubliez pas d'ajuster la hauteur de l'axe Z après G28 ou pour ces commandes `Z_tilt` et `quad_gantry_level`

* Les noms de section doivent être correctement en majuscules et minuscules, sinon Klipper signalera `Unknown pin chip name 'probe'`