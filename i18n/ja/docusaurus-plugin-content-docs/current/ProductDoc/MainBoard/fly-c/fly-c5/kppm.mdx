---
sidebar_position: 11
---

# Klipper電源喪失再開印刷機能

## 概要

- Klipperの電源喪失再開印刷機能とは、Klipperが電源を切った後に再度電源を入れると、Klipperの印刷状態を自動的に復元できる機能です。
- この機能は安全シャットダウンモジュールとの連携が必要です。
- Z軸が電力喪失時に移動する機種には適用されません。

## 設定

### 電源喪失シャットダウンの無効化
    :::danger 注意
    - 電源喪失シャットダウンを無効にしないと、この機能を使用できません。
    - 電源喪失再開印刷機能には保存後に自動的にシャットダウンする機能があります。
    :::

- デバイスのIPアドレスをブラウザのURLバーに入力してアクセスします。例: `http://192.168.6.179`
- 設定ページにアクセス
    - デバイスのIPアドレス (`http://192.168.1.2/`) をブラウザで開きます。
    - Fluidの場合、左図のように「チェックを外す」 -> 「隠しファイルをフィルタリング」。
    - Mainsailの場合、右図のように「チェックを入れる」 -> 「隠しファイルを表示」。

    <table>
      <tr>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config1.webp').default} size="100%" align="center" />
        </td>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config2.webp').default} size="85%" align="center" />
        </td>
      </tr>
    </table>

    - `.flyos-config` フォルダが見えるようになり、その中に `sys-config.conf` ファイルがあります。
    - `sys-config.conf` ファイルは、移動可能なドライブ `FlyOS-Conf` の中の設定ファイル `config.txt` のシンボリックリンクです。

    <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config3.webp').default} size="60%" align="center" />

    - `sys-config.conf` ファイルを開き、`shutdown_pin_state` と `shutdown_pin=` という設定を探します。
    - これらの設定の前に `#` を追加します。
    - その後、「保存」 -> 「閉じる」してから再起動してください。
    <ImageView image={require('@site/docs/General/flyos-fast/img/kppm.webp').default} size="90%" align="center" />

### plr.cfg 設定ファイル

- プリンターの設定ページで `plr.cfg` ファイルを見つけます。
- その中の内容をすべて削除し、下記の内容をコピーして貼り付けます。
- 設定ファイルの内容は以下の通りです：

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    power_pin: !host:gpiochip0/gpio260 # 安全シャットダウンモジュールのシャットダウンピンは、ホストPCのPA21ピンにつなぐ
    is_shutdown: True # シャットダウン操作を行うかどうか、デフォルトでは有効
    paused_recover_z: -2.0 # 停止時に一時停止中だった場合のZ軸の移動距離、デフォルトでは移動しない
    start_gcode:
        # 再開印刷前の実行されるGコード
        # 電源喪失前に保存されたすべてのパラメータは{PLR}で取得可能
        # すべての利用可能なパラメータを表示するにはM118 {PLR}を使用
        M118 再開印刷: {PLR.print_stats.filename}
        M118 中断位置: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; 熱ベッド温度を設定
        M104 S{PLR.extruder.target-10}  ; エクストルーダー温度を設定
        M109 S{PLR.extruder.target-10}  ; エクストルーダー温度が設定値に達するまで待ちます
        G91                             ; 相対座標
        G1 Z2 F100                      ; Z軸を上げてX,Y軸をリセット準備
        G90                             ; 絶対座標
        G28 X Y                         ; X,Y軸をリセット
        M140 S{PLR.bed.target}          ; 熱ベッド温度を設定
        M104 S{PLR.extruder.target}     ; エクストルーダー温度を設定
        M190 S{PLR.bed.target}          ; 熱ベッドが設定温度に達するまで待ちます
        M109 S{PLR.extruder.target}     ; エクストルーダーが設定温度に達するまで待ちます
        M83                             ; 相対エクストルード
        # G1 E0.5 F400                  ; 少し押し出す
    layer_count: 2 # 指定した層数分印刷後、layer_change_gcodeを実行
    layer_change_gcode:                
        # {layer_count}層印刷後の実行されるGコード
        M118 再開印刷速度
        M106 S{PLR.fan_speed}             ; 吹き出しファンをオンにする
        M220 S{PLR.move_speed_percent}    ; 移動速度パーセンテージを設定
        M221 S{PLR.extrude_speed_percent} ; エクストルード速度パーセンテージを設定
    shutdown_gcode:
        # シャットダウン前の実行されるGコード
        M118 電圧が低い、シャットダウン
        # M112 ; 緊急停止

    ```

    :::warning 注意

    - 上記の設定ファイルの `start_gcode` マクロは、機器の実際の状況に応じて修正が必要です。

    :::

- 上記の設定ファイルを保存後
- `printer.cfg` ファイルを開き、ファイルの一番最初に以下の内容を追加します：

    ```cfg

    [include plr.cfg]

    ```

- 右上の「保存」ボタンをクリックして再起動します。
- これで、Klipperの電源喪失再開印刷機能の設定は完了です。

## テスト

- 任意のファイルを印刷し、印刷中に「緊急停止」ボタンをクリックして電源喪失をシミュレーションします。
- 再び「ファームウェア再起動」をクリックし、Klipperが正常に接続されるのを待ちます。
- ページやKlipperScreenでポップアップが表示されたら、電源喪失再開印刷機能が正常に動作しています。
- 次に、実際の電源喪失状況でもテストできます。

