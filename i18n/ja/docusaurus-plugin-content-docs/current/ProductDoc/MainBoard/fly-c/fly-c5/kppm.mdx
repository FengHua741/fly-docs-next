---
sidebar_position: 9
---

# Klipper電源喪失再開機能

## 概要

- Klipperの電源喪失再開機能は、Klipperが電源を切った後、再度電源を入れると自動的にKlipperの印刷状態を復元できる機能です。
- この機能にはセーフティシャットダウンモジュールとの連携が必要です。
- 停電時にZ軸が移動する機種には適用されません。

## 設定

### 電源喪失シャットダウンの無効化
    :::danger 注意
    - 電源喪失シャットダウンを無効にしないと、この機能を使用できません。
    - 電源喪失再開機能には保存後に自動でシャットダウンする機能があります。
    :::

- デバイスのIPアドレスをブラウザのURLバーに入力してアクセスします。例: `http://192.168.6.179`
- 設定ページにアクセスします
    - デバイスのIPアドレス (`http://192.168.1.2/`) をブラウザで開きます。
    - Fluiddでは下図左のように「チェックを外す」 -> 「隠しファイルをフィルタリング」。
    - Mainsailでは下図右のように「チェックをつける」 -> 「隠しファイルを表示」。

    <table>
      <tr>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config1.webp').default} size="100%" align="center" />
        </td>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config2.webp').default} size="85%" align="center" />
        </td>
      </tr>
    </table>

    - これにより `.flyos-config` フォルダが見えます。このフォルダ内には `sys-config.conf` ファイルがあります。
    - `sys-config.conf` ファイルは、可搬可能なディスク `FlyOS-Conf` の設定ファイル `config.txt` のシンボリックリンクです。

    <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config3.webp').default} size="60%" align="center" />

    - `sys-config.conf` ファイルを開き、`shutdown_pin_state` と `shutdown_pin=` という設定を探します。
    - これらの設定の前に # を追加します。
    - その後 `保存` -> `閉じる` して再起動してください。
    <ImageView image={require('@site/docs/General/flyos-fast/img/kppm.webp').default} size="90%" align="center" />

### plr.cfg 設定ファイル

- プリンターの設定ページで `plr.cfg` ファイルを見つけます。
- ファイルの中身をクリアにして、以下の内容を貼り付けます。
- 設定ファイルの内容は次の通りです：

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    power_pin: !host:gpiochip0/gpio260 # セーフティシャットダウンモジュールのシャットダウンピンは、ホストPCのPA21ピンに接続されています
    is_shutdown: True # シャットダウン操作を実行するかどうか、デフォルトは有効
    paused_recover_z: -2.0 # 停止中に一時停止した場合の再開時のZ軸移動距離、デフォルトは移動しない
    start_gcode:
        # 再開前のGコードの実行
        # 停電前に保存されたすべてのパラメータは{PLR}で取得できます
        # M118 {PLR}ですべての利用可能なパラメータを出力できます
        M118 再開: {PLR.print_stats.filename}
        M118 中断位置: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; 熱ベッド温度の設定
        M104 S{PLR.extruder.target-10}  ; エクストルーダー温度の設定
        M109 S{PLR.extruder.target-10}  ; エクストルーダー温度が設定温度に達するまで待ちます
        G91                             ; 相対座標
        G1 Z2 F100                      ; Z軸を上げてX,Y軸をリセット準備
        G90                             ; 絶対座標
        G28 X Y                         ; X,Y軸をリセット
        M140 S{PLR.bed.target}          ; 熱ベッド温度の設定
        M104 S{PLR.extruder.target}     ; エクストルーダー温度の設定
        M190 S{PLR.bed.target}          ; 熱ベッドが設定温度に達するまで待ちます
        M109 S{PLR.extruder.target}     ; エクストルーダーが設定温度に達するまで待ちます
        M83                             ; 相対エクストルード
        # G1 E0.5 F400                  ; 少量の押し出し
    layer_count: 2 # 指定した層数分の再開後にlayer_change_gcodeを実行
    layer_change_gcode:                
        # {layer_count}層分の再開後に実行されるGコード
        M118 再開印刷速度
        M106 S{PLR.fan_speed}             ; ブロワーファンをオン
        M220 S{PLR.move_speed_percent}    ; 要求速度のパーセントを設定
        M221 S{PLR.extrude_speed_percent} ; 要求エクストルード速度のパーセントを設定
    shutdown_gcode:
        # シャットダウン前のGコード
        M118 電圧低下、シャットダウン
        # M112 ; 緊急停止

    ```

    :::warning 注意

    - 上記の設定ファイル内の `start_gcode` マクロは、機器の実際の状況に応じて修正する必要があります。

    :::

- 上記の設定ファイルを保存した後
- `printer.cfg` ファイルを開き、ファイルの一番最初に以下の内容を追加します：

    ```cfg

    [include plr.cfg]

    ```

- 右上の「保存」をクリックして再起動します。
- これでKlipperの電源喪失再開機能の設定は完了です。

## テスト

- 任意のファイルを印刷中に「緊急停止」ボタンをクリックして電源喪失をシミュレートします。
- 次に「ファームウェア再起動」をクリックして、Klipperが正常に接続されるのを待ちます。
- ページまたはKlipperScreenでポップアップが表示された場合、電源喪失再開機能が正常に動作しています。
- 後ほど本物の停電状況でもテストできます。

---
