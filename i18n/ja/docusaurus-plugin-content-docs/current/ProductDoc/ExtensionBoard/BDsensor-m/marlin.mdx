---
sidebar_position: 3
sidebar_label: Marlinの使用
---

# **BDsensor-m-m**のインストール

## センサーケーブルをメインボードのEXP1ポートに接続する
    *センサーのケーブル長が足りない場合は、梱包に同梱されている延長線を使用してください。
    * BDsensor-m-mのCKLおよびSDAラインは、基板の任意のGPIOピンに接続できます。BDセンサーケーブルを直接Bltouchポートに接続することも可能です。例えば：

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Input)
    GND      -->     GND
    Zmin     -->     SDA    (Input/Output) 
    ```

    * 主板コネクタ内のいくつかのピンはMCUのGPIOに直接接続されていない場合があります（例えば、フィルタコンデンサやMOSFET、ダイオード、オプトカプラで隔離されている可能性がありますが、抵抗やプルアップ/ダウンの抵抗で隔離されている場合は使用可能です）。したがって、それらはBDsensor-mと一緒に使用できません。そして、ファームウェアは接続エラーを報告します。例えば

    * ファンとヒーターのコネクタはMOSFETで隔離されています。
    * 温度サーミスタおよびエンドストップ/プローブ用のコネクタは、通常GNDにフィルタコンデンサで接続されています。

1. 下の図のように、BDセンサーをホットエンドの近くに取り付けます。 [STL of mount](https://www.thingiverse.com/thing:6098131),  [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/BDsensor-m/img/jxcs_webp.webp').default} size="100%" align="left" />



## Marlinファームウェアにパッチを適用する

    BDセンサーはMarlin2.1.xに統合されています（2022.8.27以降）、

    リリースバージョンをダウンロードできますが、現在は最新のバグフィックスバージョンをダウンロードすることをお勧めします：https://github.com/MarlinFirmware/Marlin

    設定ファイルとピンファイルを変更する必要があります。

### configuration.hの編集

1. BD_SENSORを有効にする

    コメントを外す

    ```bash
    #define BD_SENSOR`
    #define Z_SAFE_HOMING
    #define BD_SENSOR_PROBE_NO_STOP //この新しい行を追加して、ノズル停止なしで高速ベッドレベリングを実行します。
    ```

    `BD_SENSOR_PROBE_NO_STOP`だけを有効にする

    最新のMarlinのバグフィックス：https://github.com/MarlinFirmware/Marlin

    説明： https://github.com/MarlinFirmware/Marlin/pull/25847

2. プローブでホームする

    `Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN`が無効になっていることを確認し、`USE_PROBE_FOR_Z_HOMING`を以下のように有効にする必要があります。

    ```bash
    //#define Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN
    // Force the use of the probe for Z-axis homing
    #define USE_PROBE_FOR_Z_HOMING
    ```

3. 二度目のZ軸ホーム速度を遅くする

    ```bash
    #define Z_PROBE_FEEDRATE_SLOW (Z_PROBE_FEEDRATE_FAST / 16)
    ```

    ここでは、BDsensor-mプロセスから読み取られるストッパーは通常のストッパーほどリアルタイムでないため、ノズルホーム速度とZ軸ホーム速度を遅くする必要があります。

    ### Configuration_adv.hの編集

    `#define BABYSTEPPING`を有効にしてリアルタイムレベリング機能を実現

    ```bash
    #define HOMING_BUMP_DIVISOR { 2, 2, 8 }       // Re-Bump Speed Divisor (Divides the Homing Feedrate)
    ```

### pins_boardname.hの編集

    BDsensor-mのSDAおよびSCLのピンを次の3行を追加して、ピンファイル`pins_boardname.h`（例：`pins_PANDA_PI_V29.h`）に設定します。

        ```bash
        #define  I2C_BD_SDA_PIN    PC6   // SDA線が接続されているメインボードの実際の番号に変更してください
        #define  I2C_BD_SCL_PIN    PB2   // SLK線が接続されているメインボードの実際の番号に変更してください
        #define  I2C_BD_DELAY  20      // デフォルト値は20で、範囲は[20,50]です。
        ```

    自動ベッドレベリングプローブ（G29）をプリント前に行う場合、以下の行のコメントを外します。

        ```bash
        #define AUTO_BED_LEVELING_BILINEAR
        ```

    以下の値を編集します。

        ```bash
        #define Z_CLEARANCE_DEPLOY_PROBE   0 // Z Clearance for Deploy/Stow
        #define Z_CLEARANCE_BETWEEN_PROBES  1 // Z Clearance between probe points
        #define Z_CLEARANCE_MULTI_PROBE     1 // Z Clearance between multiple probes
        ```



## 液晶画面にBDセンサーの値を表示する

    * プリンタにステータス表示機能がある場合（gcode M117をサポート）、例えばLCD12864や一部のuartスクリーン、ender3V2など...

## 校正

    1. ノズルを清掃し、コンソールでZ軸を移動させ、ノズルがベッドに接触するまで調整します（BDsensor-mはこの位置を0点として使用するため、z_offsetは必要ありません）。値を0に設定します。
    2. gcodeコマンド`M102 S-6`を送信すると、プリンタは0.1mmずつZ軸をゆっくりと上昇させ、4mmに到達するまで続けます。センサーの取り付け前にM102 S-6を実行しないでください。また、校正中にプリンタの電源を切らないでください。古い校正データが削除される可能性があります。その場合、再度校正してください。

    3. `M102 S-5`を送信してBDセンサーの校正が成功したかどうかを確認できます。これはBDセンサーに保存されている元の校正データを返します。

    校正ツールもあります：https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip ![img](https://raw.githubusercontent.com/markniu/Bed_Distance_sensor/main/doc/images/Read.jpg)

    注意：データ値が1015または>1010の場合、センサーの範囲を超えていることを示します。最初の5点（0~0.5mm）またはそれ以上の値が0から1000の範囲内であり、増加値deltaが>=10の場合、校正成功を示します。上のグラフのように。

    M102 S-5が返す最初の元校正データが400を超える場合、センサーが高すぎて取り付けられていることを意味します。ベッドに近い位置に再インストールしてください。また、2番目のデータが1番目のデータ値よりも10以上大きいことを確認してください。

## テストとプリント

    メニューベッド

    自動ベッド

## ベッドを自動レベリングする方法は2つあります：

    **1. 最初の数層をM102でリアルタイムにレベリングする**

        これを有効または無効にするために、gcodeコマンドを送信したり、gcodeファイルに追加したりできます。

        キュラでベッドレベリングを有効にするには、「スタートGコード」セクションのG102（全軸ホーム）Gコードのすぐ下にM28 Gコードを追加します。例えば、G28の下にこれを追加すると、Z軸の高さが0.2mm以下の場合にのみベッドレベリングが行われます。`M102 S2`

        BDセンサーを使用してベッドレベリングを無効にするには、以下のコマンドを送信します。`M102 S0``G28``M18`

        ```bash
        M102   S-1     //センサー情報を読み取る、これを使って接続チェックができます。
        M102   S-2     //現在の距離値を読み取る
        M102   S-5     //元の校正データを読み取る
        M102   S-6     //校正を開始する、ノズルがベッドに接触した状態でプリンタを再起動する前に確認してください。Z軸をホームしないでください。
        M102   S4      //調整可能なZ高さ値を設定、例えばM102 S4はZ高さが0.4mm以下で調整を行います、M102 S0で無効化。
        ```

    **2. G29自動ベッドレベリング**

        G29のようなBLtouchの自動ベッドレベリング方法もあります。G29の下に1行追加します。

        [インストールビデオ](https://www.pandapi3d.com/post/install-bed-distance-sensor-video)

        [クリスの地下室のインストールビデオ](https://youtu.be/VLUfvkO2NFc?si=PF_6nhw39KhHBhcj)

### Zエンドストップのチェック`M119`

    このステップをチェックする前に、Z軸をホームしないでください。そうしないとノズルがプリンターベッドに接触する可能性があります。

    これはM119コマンド（エンドストップステータスレポート）を送信した後の返信メッセージです。

    ```bash
    Send: M119
    Recv: x:open y:open z:open
    ```

    z minが開いていない場合、設定を確認してください。`#define Z_MAX_ENDSTOP_HIT_STATE HIGH`

    - Zモーターをオフ/ロック解除にしてください
    - 手でZ軸を下に動かし、ノズルがベッドに接触するまで
    - `M102 S-2`を送信すると、返信値は0.00mmになるはずです。その後、再度M119を送信すると、zエンドストップがトリガーされたことが確認できます。

    ```bash
    Send: M119
    Recv: x:open y:open z:TRIGGERED
    ```

    ### 接続のチェック

    `M102 S-1`で接続をチェックします。これは返信メッセージの例です。接続とワイヤーの順序が正しいかどうかを確認してください。空白または他の文字列が返された場合。

    ```bash
    Send: M102 S-1
    Recv: V1.0 pandapi3d.com
    ```



##  上記のすべての手順が正しければ、Z軸をホームすることができます。