## 設定

### 停電シャットダウンの無効化
    :::danger 注意
    - 停電シャットダウンを無効にしないと、停電継続印刷が使用できません。
    - 停電継続印刷には、進捗保存後に自動でシャットダウンする機能があります。
    :::

- ブラウザのURLバーに入力してデバイスのIPアドレスにアクセスします。例: `http://192.168.6.179`
- 設定ページに進む
    - デバイスのIPアドレス (`http://192.168.1.2/`) をブラウザで開く
    - FluidDでは左図のように「チェックを外す」->「隠しファイル・フォルダをフィルタリング」。
    - MainSailでは右図のように「チェックを入れる」->「隠しファイルを表示」。
    
    <table>
      <tr>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config1.webp').default} size="100%" align="center" />
        </td>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config2.webp').default} size="85%" align="center" />
        </td>
      </tr>
    </table>

    - これにより `.flyos-config` フォルダが見えるようになり、その中に `sys-config.conf` ファイルがあります。
    - `sys-config.conf` ファイルは、移動可能なディスク `FlyOS-Conf` 内の設定ファイル `config.txt` のシンボリックリンクです。

    <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config3.webp').default} size="60%" align="center" />

    - `sys-config.conf` ファイルを開き、`shutdown_pin_state` および `shutdown_pin=` という設定を見つける
    - この設定の前に `#` を追加する
    - その後、「保存」→「閉じる」して再起動する
    <ImageView image={require('@site/docs/General/flyos-fast/img/kppm.webp').default} size="90%" align="center" />

### plr.cfg 設定ファイル
    :::danger 注意
    * 設定ファイル内の: (PINS)  
    * を <code>{props.power_pine}</code> に置き換える必要があります

    :::

    - プリンター設定ページで `plr.cfg` ファイルを探します。
    - ファイルの中身を空にして、下記の設定を貼り付けます
    - 設定ファイルの内容は次の通り:

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    power_pin: (PINS)
    is_shutdown: True # シャットダウン操作を行うかどうか、デフォルトは有効
    paused_recover_z: -2.0 # 停止時に一時停止していた場合のZ軸移動距離、デフォルトは移動しない
    start_gcode:
        # 続けて印刷開始前に実行されるGコード
        # 停電前に保存されたすべてのパラメータは{PLR}で取得可能
        # 使用方法: M118 {PLR}で利用可能なすべてのパラメータを出力
        M118 印刷再開: {PLR.print_stats.filename}
        M118 停止位置: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; 熱ベッド温度を設定
        M104 S{PLR.extruder.target-10}  ; エクストルーダー温度を設定
        M109 S{PLR.extruder.target-10}  ; エクストルーダー温度が設定値に達するまで待ちます
        G91                             ; 相対座標
        G1 Z2 F100                      ; Z軸を上げてX,Y軸をリセット準備
        G90                             ; 絶対座標
        G28 X Y                         ; X,Y軸をリセット
        M140 S{PLR.bed.target}          ; 熱ベッド温度を設定
        M104 S{PLR.extruder.target}     ; エクストルーダー温度を設定
        M190 S{PLR.bed.target}          ; 熱ベッドが設定温度に達するまで待ちます
        M109 S{PLR.extruder.target}     ; エクストルーダーが設定温度に達するまで待ちます
        M83                             ; 相対的なエクストルーダー
        # G1 E0.5 F400                  ; 少量押し出し
    layer_count: 2 # 指定した層数でlayer_change_gcodeを実行
    layer_change_gcode:                
        # {layer_count}層印刷後に実行されるGコード
        M118 再開印刷速度
        M106 S{PLR.fan_speed}             ; 吹き出しファンをオンにする
        M220 S{PLR.move_speed_percent}    ; 要求速度パーセントを設定
        M221 S{PLR.extrude_speed_percent} ; 要求押出速度パーセントを設定
    shutdown_gcode:
        # シャットダウン前に実行されるGコード
        M118 電源電圧低、シャットダウン
        # M112 ; 緊急停止

    ```

    :::warning 注意

    - 上記の設定ファイル内の `start_gcode` マクロは、機械の実際の状況に応じて修正する必要があります。
    - `[homing_override]` を使用している場合は、[homing_override] 内で無作為にリファイン位置を設定しないでください。それによる停電継続印刷の失敗については責任を負いかねます。

    :::

- 上記の設定ファイルを保存後
- `printer.cfg` ファイルを開き、先頭に以下の内容を追加する:

    ```cfg

    [include plr.cfg]

    ```

- 右上の「保存」をクリックして再起動する
- これでKlipperの停電継続印刷機能の設定は完了です。

## テスト

- 任意のファイルを印刷し、印刷中に「緊急停止」ボタンをクリックして停電をシミュレーションする
- 「ファームウェア再起動」を再度クリックして、Klipperが正常に接続されるのを待ちます
- ページやKlipperScreenでポップアップが表示されれば、停電継続印刷機能が正常に動作しています
- 後続は実際に停電した状況でのテストも可能です
