---
sidebar_position: 11
---

# Klipper 전력 차단 후 이어하기 기능

## 개요

- Klipper 전력 차단 후 이어하기 기능은 Klipper가 전원이 꺼진 후 다시 켜졌을 때, Klipper의 인쇄 상태를 자동으로 복구하는 기능입니다.
- 이 기능은 안전 전원 모듈과 함께 사용해야 합니다.
- 전원이 끊겼을 때 Z축이 이동하는 기계에는 적용되지 않습니다.

## 설정

### 전원 차단 끄기
    :::danger 주의사항
    - 전원 차단을 끄지 않으면 전력 차단 후 이어하기 기능을 사용할 수 없습니다.
    - 전력 차단 후 이어하기에는 저장된 상태 후 자동 전원 차단 기능이 포함되어 있습니다.
    :::

- 장치의 IP 주소를 브라우저의 주소 표시줄에 입력하여 설정 페이지로 접속합니다. 예: `http://192.168.6.179`
- 설정 페이지로 이동합니다.
    - 장치의 IP 주소를 브라우저에서 열어주세요. 예: `http://192.168.1.2/`
    - Fluidd는 아래 왼쪽 그림처럼 `체크박스 해제` -> `숨김 파일 및 폴더 필터링`을 선택합니다.
    - Mainsail은 아래 오른쪽 그림처럼 `체크박스 선택` -> `숨겨진 파일 표시`를 선택합니다.
    
    <table>
      <tr>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config1.webp').default} size="100%" align="center" />
        </td>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config2.webp').default} size="85%" align="center" />
        </td>
      </tr>
    </table>

    - 이제 `.flyos-config` 폴더를 볼 수 있으며, 이 폴더 안에는 `sys-config.conf` 파일이 있습니다.
    - `sys-config.conf` 파일은 플러그인 드라이브 `FlyOS-Conf`의 설정 파일인 `config.txt`의 소프트링크입니다.

    <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config3.webp').default} size="60%" align="center" />

    - `sys-config.conf` 파일을 열고 `shutdown_pin_state`와 `shutdown_pin=` 설정을 찾습니다.
    - 해당 설정 앞에 #을 추가합니다.
    - `저장` -> `닫기` 후 재부팅하면 됩니다.
    <ImageView image={require('@site/docs/General/flyos-fast/img/kppm.webp').default} size="90%" align="center" />

### plr.cfg 설정 파일

- 프린터 설정 페이지에서 `plr.cfg` 파일을 찾습니다.
- 파일 내용을 비운 다음 아래 설정을 붙여넣습니다.
- 설정 파일 내용은 다음과 같습니다:

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    power_pin: !host:gpiochip0/gpio260 # 안전 전원 모듈의 전원 차단 핀, 상위 기기의 PA21 핀에 연결
    is_shutdown: True # 전원 차단 여부, 기본값은 활성화
    paused_recover_z: -2.0 # 일시 중지된 상태에서 전원이 끊겼을 경우 Z 축 이동 거리, 기본값은 이동하지 않음
    start_gcode:
        # 계속하기 전에 실행되는 gcode
        # 전원이 끊기기 전에 저장된 모든 매개변수는 {PLR}를 통해 가져올 수 있습니다
        # 모든 사용 가능한 매개변수를 출력하려면 M118 {PLR}를 사용하세요
        M118 시작 계속하기: {PLR.print_stats.filename}
        M118 중단 위치: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; 열판 온도 설정
        M104 S{PLR.extruder.target-10}  ; 엑스트루더 온도 설정
        M109 S{PLR.extruder.target-10}  ; 엑스트루더가 설정 온도까지 가열되길 기다림
        G91                             ; 상대 좌표
        G1 Z2 F100                      ; Z 축 상승, X,Y 리셋 준비
        G90                             ; 절대 좌표
        G28 X Y                         ; X,Y 리셋
        M140 S{PLR.bed.target}          ; 열판 온도 설정
        M104 S{PLR.extruder.target}     ; 엑스트루더 온도 설정
        M190 S{PLR.bed.target}          ; 열판이 설정 온도까지 가열되길 기다림
        M109 S{PLR.extruder.target}     ; 엑스트루더가 설정 온도까지 가열되길 기다림
        M83                             ; 상대적 엑스트루드
        # G1 E0.5 F400                  ; 약간의 엑스트루드
    layer_count: 2 # 지정한 층 수만큼 연속 인쇄 후 layer_change_gcode 실행
    layer_change_gcode:                
        # {layer_count}층 후 실행할 gcode
        M118 인쇄 속도 복원
        M106 S{PLR.fan_speed}             ; 블로워 팬 활성화
        M220 S{PLR.move_speed_percent}    ; 요청 속도 백분율 설정
        M221 S{PLR.extrude_speed_percent} ; 요청 엑스트루드 속도 백분율 설정
    shutdown_gcode:
        # 전원 차단 전에 실행할 gcode
        M118 전압 저하로 전원 차단
        # M112 ; 긴급 정지

    ```

    :::warning 주의사항

    - 위 설정 파일의 `start_gcode` 매크로는 실제 기계 상태에 따라 수정해야 할 수 있습니다.

    :::

- 설정 파일을 저장한 후
- `printer.cfg` 파일을 열고 파일 맨 앞에 다음 내용을 추가합니다:

    ```cfg

    [include plr.cfg]

    ```

- 오른쪽 상단의 저장 버튼을 클릭하고 재부팅하면 됩니다.
- 이제 Klipper 전력 차단 후 이어하기 기능이 설정 완료되었습니다.

## 테스트

- 임의의 파일을 인쇄하다가 인쇄 도중 `긴급 정지` 버튼을 클릭하여 전원 차단 시뮬레이션을 수행합니다.
- 다시 `펌웨어 재시작`을 클릭하고 Klipper가 정상적으로 연결될 때까지 기다립니다.
- 웹페이지 또는 KlipperScreen에서 팝업 메시지가 나타나면 전력 차단 후 이어하기 기능이 정상 작동합니다.
- 이후 실제 전원 차단 상황에서도 테스트할 수 있습니다.
