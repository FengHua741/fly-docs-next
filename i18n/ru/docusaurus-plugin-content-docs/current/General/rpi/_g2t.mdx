## Важные замечания:

    * Убедитесь, что перед установкой расширительной пластины компьютер выключен.
    * Избегайте использования расширительной панели в условиях повышенной влажности или сильного пыления.
    * При установке экрана обратите внимание на направление кабеля и избегайте разъединения его при подаче напряжения.
    * При установке вентилятора учитывайте его токовые и напряжённостные характеристики.
    * Обратите внимание, что UART1 уже включён по умолчанию и не требует настройки.
    * Пожалуйста, обновите образ, например, `mainsailos`, а не ядро.
    * **Все интерфейсы Raspberry Pi можно использовать!**
    * **Внимание:** Версия ядра системы Raspberry Pi должна быть выше `5.17.x`. Для проверки выполните команду `uname -r`.

## Ссылки на загрузку предустановленной системы TFTV2 для Raspberry Pi

    * Образ системы для Raspberry Pi 3B/3B+/4B/CM4/5B

    ```cfg
    https://cdn.mellow.klipper.cn/IMG/Beta/RPI-TFT-IMG-new.img.xz
    ```

## Установка драйверов экрана

    * Обратите внимание, что можно использовать предустановленную систему
    * Адрес репозитория проекта: [FLY-TFT](https://github.com/kluoyun/FLY-TFT)

### Описание

    FLY-TFT-V2 — это TFT-экран на основе стековой платы ST7796, поддерживающий как емкостное, так и резистивное сенсорное управление, с разрешением 320x480, использующий интерфейс SPI.

    * Необходимо самостоятельно установить [KlipperScreen](https://klipperscreen.readthedocs.io/en/latest/Installation/)

### Установка системы

:::warning Важные замечания
Внимание: версия ядра системы Raspberry Pi должна быть выше `5.17.x`. Для проверки выполните команду `uname -r`.
Пожалуйста, обновите образ, например, `mainsailos`, а не ядро.
:::

* Используйте [Raspberry Imager](https://www.raspberrypi.com/software/) для установки последней версии **MainsailOS**
    1. Скачайте и установите [Raspberry Imager](https://www.raspberrypi.com/software/)
    2. Откройте **Raspberry Imager**
    3. Нажмите **CHOOSE DEVICE**
    4. Выберите соответствующую модель устройства
    5. Нажмите **CHOOSE OS**
    6. Выберите **Other specific-purpose OS**
    7. Выберите **3D printing**
    8. Выберите **Mainsail OS**
    9. Выберите последнюю версию. Если ваша конфигурация поддерживает 64-битную систему, выберите **rpi64**
    10. Нажмите **CHOOSE STORAGE**
    11. Выберите ваше устройство хранения, например, карту SD
    12. Нажмите **NEXT**, подождите окончания установки

### Установка драйверов

    * Установите драйверы для FLY-TFT-V2
    
    ```bash
    git clone https://github.com/kluoyun/FLY-TFT.git
    cd FLY-TFT
    sudo chmod +x ./scripts/install.sh
    ./scripts/install.sh
    ```

### Активация TFT-экрана

    * Для работы с сенсором необходима поддержка I²C (`dtparam=i2c_arm=on`).

    1. После установки драйверов добавьте в файл config.txt следующее покрытие: `dtoverlay=fly-tft-v2`
    2. Откройте файл `/boot/config.txt` (в системе bookworm — `/boot/firmware/config.txt`)
        ```bash
        sudo nano /boot/config.txt
        ```
    3. В конце файла добавьте следующие настройки:
    ```bash
        dtoverlay=fly-tft-v2
    ```
    * По умолчанию экран отображается в горизонтальной ориентации на 90 градусов. Если необходимо изменить ориентацию экрана, используйте следующие настройки:
    ```bash
        dtoverlay=fly-tft-v2,r90  # В горизонтальном положении, как по умолчанию
        dtoverlay=fly-tft-v2,r270 # В горизонтальном положении (перевёрнутый)
        dtoverlay=fly-tft-v2,r0   # В вертикальном положении
        dtoverlay=fly-tft-v2,r180 # В перевёрнутом вертикальном положении
    ```
        * Можно добавить только одну настройку, нельзя несколько одновременно
        * Как правило, направление сенсора автоматически изменяется вместе с направлением экрана, поэтому не требуется изменять системные настройки сенсора
    4. После добавления настроек выполните команду `sudo reboot`, чтобы перезагрузить систему

### Использование TFT

    * Убедитесь, что соединение с оборудованием выполнено правильно
    * Установлены драйверы
    * В файле `/boot/config.txt` (в системе bookworm — `/boot/firmware/config.txt`) добавлено покрытие `dtoverlay=fly-tft-v2`
    * В некоторых системах по умолчанию может быть установлен устройство fb0, тогда FLY-TFT будет назначен fb1. Для активации fb1 выполните следующие действия:
    * Выполните команду `ls /dev/fb*` для просмотра устройств. Если есть два устройства fb0 и fb1, выполните следующую команду для активации fb1 (по умолчанию используется fb0):
    * Выполните команду для изменения настройки по умолчанию на fb1:
        ```bash
        sudo sed -i 's/\/dev\/fb0/\/dev\/fb1/g' /etc/X11/xorg.conf.d/99-fbdev.conf
        ```

### Использование KlipperScreen

    * В системе MainsailOS KlipperScreen не установлен по умолчанию, требуется ручная установка
    * Подробнее см. в документации [KlipperScreen](https://github.com/KlipperScreen/KlipperScreen) или используйте [kiauh](https://github.com/dw-0/kiauh) для установки
    * Если успешно установлен KlipperScreen и выполнены все предыдущие шаги, интерфейс KlipperScreen должен уже отобразиться

### Все доступные настройки

    * `speed` [**необходимый параметр**]: Устанавливает максимальную частоту SPI для TFT, в Гц, по умолчанию 96000000 (если возникает серьёзная засветка, снизьте значение)
    * Пример: `dtoverlay=fly-tft-v2,speed=80000000` 

    * `r0/r90/r180/r270` [**опциональный параметр**][**без параметров**]: Устанавливает ориентацию отображения и сенсора TFT, по умолчанию 90 градусов, возможные значения 0, 90, 180, 270 (только одна настройка может быть указана)
    * Пример: `dtoverlay=fly-tft-v2,r90` или `dtoverlay=fly-tft-v2,r180`

    * `disable_touch` [**без параметров**]: Отключает функцию сенсора TFT, по умолчанию включена
    * Пример: `dtoverlay=fly-tft-v2,disable_touch`

    * `invx`,`invy` [**без параметров**]: Устанавливает направление сенсора TFT, `invx` — инвертирование направления X, `invy` — инвертирование направления Y
    * Пример: `dtoverlay=fly-tft-v2,invx` или `dtoverlay=fly-tft-v2,invy` или `dtoverlay=fly-tft-v2,invx,invy`

    * `swapxy` [**без параметров**]: Устанавливает направление сенсора TFT, оси X и Y меняются местами, то есть в горизонтальной ориентации
        * Пример: `dtoverlay=fly-tft-v2,swapxy`

    > **Внимание:** Все параметры могут быть указаны одновременно (опциональные параметры могут быть указаны только один), параметры разделяются запятой, несколько параметров могут быть указаны только в одной строке

    > **Внимание:** Обычно используются только параметры `r0`, `r90`, `r180`, `r270`. Остальные параметры применяются только в специальных случаях, особенно `invx`, `invy`, `swapxy`
    * Пример: `dtoverlay=fly-tft-v2,speed=80000000,r270`
