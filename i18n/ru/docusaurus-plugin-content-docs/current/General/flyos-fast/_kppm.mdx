## Настройка

### Отключение автовыключения при отключении питания
    :::danger Важно
    - Для использования функции автозавершения печати необходимо отключить автовыключение при отключении питания.
    - В функции автозавершения печати есть возможность автоматического выключения после сохранения прогресса.
    :::

- Введите IP-адрес устройства в адресную строку браузера, например: `http://192.168.6.179`
- Перейдите на страницу настроек
    - Откройте в браузере IP-адрес устройства, например: `http://192.168.1.2/`
    - В Fluidd снимите галочку с пункта -> `Скрыть скрытые файлы и папки`.
    - В Mainsail поставьте галочку -> `Показать скрытые файлы`.
    
    <table>
      <tr>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config1.webp').default} size="100%" align="center" />
        </td>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config2.webp').default} size="85%" align="center" />
        </td>
      </tr>
    </table>

    - Теперь можно увидеть папку `.flyos-config`, перейдя в которую найдете файл `sys-config.conf`.
    - Файл `sys-config.conf` является символической ссылкой на файл конфигурации `config.txt` на мобильном носителе `FlyOS-Conf`.

    <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config3.webp').default} size="60%" align="center" />

    - Откройте файл `sys-config.conf` и найдите настройки `shutdown_pin_state` и `shutdown_pin=`.
    - Добавьте перед этими настройками символ `#`.
    - Сохраните изменения, закройте файл и перезагрузите устройство.
    <ImageView image={require('@site/docs/General/flyos-fast/img/kppm.webp').default} size="90%" align="center" />

### Конфигурационный файл plr.cfg
    :::danger Важно
    * Пожалуйста, замените следующее в файле конфигурации: (PINS)  
    * на <code>{props.power_pine}</code>

    :::

    - В разделе настроек принтера найдите файл `plr.cfg`.
    - Очистите содержимое файла, а затем вставьте нижеуказанную конфигурацию:
    - Содержимое файла конфигурации:

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    power_pin: (PINS)
    is_shutdown: True # Выполнять ли операцию выключения, по умолчанию включено
    paused_recover_z: -2.0 # Если приостановка печати произошла во время остановки, расстояние перемещения Z при возобновлении печати, по умолчанию не двигаться
    start_gcode:
        # G-code, выполняемый перед возобновлением печати
        # Все параметры, сохраненные перед выключением питания, доступны через {PLR}
        # Могут быть выведены командой M118 {PLR}
        M118 Начало возобновления печати: {PLR.print_stats.filename}
        M118 Точка остановки: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; Установка температуры нагревательного стола
        M104 S{PLR.extruder.target-10}  ; Установка температуры экструдера
        M109 S{PLR.extruder.target-10}  ; Ожидание нагрева экструдера до заданной температуры
        G91                             ; Относительные координаты
        G1 Z2 F100                      ; Подъем Z для подготовки к нулевым координатам X,Y
        G90                             ; Абсолютные координаты
        G28 X Y                         ; Обнуление X и Y
        M140 S{PLR.bed.target}          ; Установка температуры нагревательного стола
        M104 S{PLR.extruder.target}     ; Установка температуры экструдера
        M190 S{PLR.bed.target}          ; Ожидание нагрева нагревательного стола до заданной температуры
        M109 S{PLR.extruder.target}     ; Ожидание нагрева экструдера до заданной температуры
        M83                             ; Относительная экструзия
        # G1 E0.5 F400                  ; Экструзия небольшого количества материала
    layer_count: 2 # Количество слоев для возобновления печати перед выполнением layer_change_gcode
    layer_change_gcode:                
        # G-code, выполняемый после возобновления печати {layer_count} слоев
        M118 Возобновление скорости печати
        M106 S{PLR.fan_speed}             ; Включение вентилятора подачи материала
        M220 S{PLR.move_speed_percent}    ; Установка процентного значения скорости перемещения
        M221 S{PLR.extrude_speed_percent} ; Установка процентного значения скорости экструзии
    shutdown_gcode:
        # G-code, выполняемый перед выключением питания
        M118 Низкое напряжение питания, выключение
        # M112 ; Срочная остановка

    ```

    :::warning Примечание

    - Макрос `start_gcode` в вышеуказанном файле конфигурации может потребовать корректировки в зависимости от особенностей конкретного оборудования.
    - Обратите внимание, что использование `[homing_override]` не рекомендуется для произвольной настройки точек возврата. За любые проблемы с автозавершением печати при использовании `[homing_override]` ответственность не несется.

    :::

- После сохранения вышеуказанного файла конфигурации
- Откройте файл `printer.cfg` и добавьте в начало файла следующее содержимое:

    ```cfg

    [include plr.cfg]

    ```

- Нажмите кнопку "Сохранить" в правом верхнем углу и перезагрузите устройство.
- Настройка функции автозавершения печати Klipper завершена.

## Тестирование

- Начните печать любого файла, во время печати нажмите кнопку "Экстренная остановка", чтобы имитировать отключение питания.
- После этого нажмите "Перезагрузка прошивки", дождитесь нормального подключения Klipper.
- Если на веб-странице или в KlipperScreen появляется всплывающее окно с уведомлением, это означает, что функция автозавершения печати работает правильно.
- Для дальнейшей проверки можно протестировать реальное отключение питания.
