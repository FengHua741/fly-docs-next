## Настройка

### Отключение автовыключения при отключении электричества
    :::danger Важно
    - Необходимо отключить автовыключение при отключении электричества, иначе функция продолжения печати после перерыва не будет работать.
    - В функции продолжения печати после перерыва есть возможность автоматического выключения после сохранения прогресса.
    :::

- Через адресную строку браузера введите IP-адрес устройства, например: `http://192.168.6.179`
- Перейдите на страницу конфигурации
    - В браузере откройте IP-адрес устройства, например: `http://192.168.1.2/`
    - В Fluidd снимите галочку в левом изображении -> "Отображение скрытых файлов и папок".
    - В Mainsail поставьте галочку в правом изображении -> "Показывать скрытые файлы".
    
    <table>
      <tr>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config1.webp').default} size="100%" align="center" />
        </td>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config2.webp').default} size="85%" align="center" />
        </td>
      </tr>
    </table>

    - Теперь можно увидеть папку `.flyos-config`, перейдя в эту папку найдете файл `sys-config.conf`.
    - Файл `sys-config.conf` является символьной ссылкой на файл конфигурации `config.txt` на мобильном носителе `FlyOS-Conf`.

    <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config3.webp').default} size="60%" align="center" />

    - Откройте файл `sys-config.conf`, найдите конфигурации `shutdown_pin_state` и `shutdown_pin=`
    - Добавьте перед этими конфигурациями символ `#`
    - Затем сохраните -> закройте и перезагрузите устройство
    <ImageView image={require('@site/docs/General/flyos-fast/img/kppm.webp').default} size="90%" align="center" />

### Конфигурационный файл plr.cfg
    :::danger Важно
    * Пожалуйста, замените в конфигурационном файле: (PINS)
    * на <code>{props.power_pine}</code>

    :::

    - В разделе настройки принтера найдите файл `plr.cfg`.
    - Очистите содержимое файла, затем вставьте ниже приведенную конфигурацию:
    - Содержимое конфигурационного файла:

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    power_pin: (PINS)
    is_shutdown: True # Выполнять ли операцию выключения, по умолчанию включено
    paused_recover_z: -2.0 # Если во время остановки печать была приостановлена, то перемещение Z при возобновлении печати, по умолчанию не перемещать
    start_gcode:
        # G-code для выполнения перед возобновлением печати
        # Все параметры, сохраненные перед отключением питания, доступны через {PLR}
        # Для вывода всех доступных параметров используйте M118 {PLR}
        M118 Начало восстановления печати: {PLR.print_stats.filename}
        M118 Точка остановки: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target-10}  ; Установка температуры сопла
        M109 S{PLR.extruder.target-10}  ; Ожидание пока сопло достигнет заданной температуры
        G91                             ; Относительные координаты
        G1 Z2 F100                      ; Подъем Z для подготовки к нулевым точкам X,Y
        G90                             ; Абсолютные координаты
        G28 X Y                         ; Обнуление X,Y
        M140 S{PLR.bed.target}          ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target}     ; Установка температуры сопла
        M190 S{PLR.bed.target}          ; Ожидание пока нагревательная платформа достигнет заданной температуры
        M109 S{PLR.extruder.target}     ; Ожидание пока сопло достигнет заданной температуры
        M83                             ; Относительная экструзия
        # G1 E0.5 F400                  ; Экструзия
    layer_count: 2 # Количество слоев для продолжения печати перед выполнением layer_change_gcode
    layer_change_gcode:                
        # G-code для выполнения после восстановления печати {layer_count} слоев
        M118 Возобновление скорости печати
        M106 S{PLR.fan_speed}             ; Включение вентилятора
        M220 S{PLR.move_speed_percent}    ; Установка процентной скорости движения
        M221 S{PLR.extrude_speed_percent} ; Установка процентной скорости экструзии
    shutdown_gcode:
        # G-code для выполнения перед выключением
        M118 Низкое напряжение питания, выключение
        # M112 ; Принудительная остановка

    ```

    :::warning Внимание

    - Конфигурационный файл выше может потребовать корректировки `start_gcode` в зависимости от конкретной модели оборудования.
    - Обратите внимание, что если используется `[homing_override]`, не рекомендуется произвольно изменять положение при настройке возвращения домой. За любые ошибки в результате несчастных случаев ответственности не несется
    - Обратите внимание, что если используется `[gcode_macro _CLIENT_VARIABLE]`, необходимо найти `variable_custom_park_dz` и установить его значение равным 0
`
    :::

- Сохраните вышеуказанный конфигурационный файл
- Откройте файл `printer.cfg` и добавьте в начало файла следующее содержимое:

    ```cfg

    [include plr.cfg]

    ```

- Нажмите кнопку "Сохранить" в правом верхнем углу и перезагрузите устройство.
- Таким образом, функция продолжения печати после перерыва в Klipper успешно настроена.

## Тестирование

- Начните печать любого файла и нажмите кнопку "Экстренная остановка" во время печати для имитации отключения электричества.
- После этого нажмите "Перезагрузить прошивку", дождитесь нормального подключения Klipper.
- Если появится всплывающее окно на веб-странице или в KlipperScreen, это означает, что функция продолжения печати работает правильно.
- Далее можно протестировать реальную ситуацию отключения электричества.
