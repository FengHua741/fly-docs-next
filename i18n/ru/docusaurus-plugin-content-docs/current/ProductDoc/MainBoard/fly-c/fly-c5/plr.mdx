---
sidebar_position: 4
---

# Возобновление печати после отключения питания в Klipper

## Общие сведения

- Функция возобновления печати после отключения питания в Klipper позволяет автоматически восстановить состояние печати после повторного включения после отключения питания.
- Для работы данной функции необходима совместная настройка модуля безопасного выключения.
- Не подходит для моделей, где после отключения питания перемещается ось Z.

## Настройка

### Конфигурационный файл plr.cfg

- В разделе конфигурации принтера нажмите «Создать новый конфигурационный файл» и создайте файл `plr.cfg`.
- Содержимое файла:

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    # power_pin: PA0 # Ножка выключения для модуля безопасного выключения, подключенная к порту PA0 нижнего контроллера
    power_pin: host:gpiochip1/gpio21 # Ножка выключения для модуля безопасного выключения, подключенная к порту PA21 верхнего контроллера
    is_shutdown: True # Выполнять ли операцию выключения, по умолчанию включено
    paused_recover_z: -2.0 # Приостановленная печать при остановке Z перемещение, по умолчанию без перемещений
    start_gcode:
        # GCode, выполняемый перед продолжением печати
        # Все параметры, сохраненные перед отключением питания, доступны через {PLR}
        # Для вывода всех доступных параметров используйте M118 {PLR}
        M118 Начало возобновления: {PLR.print_stats.filename}
        M118 Точка прерывания: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target-10}  ; Установка температуры сопла
        M109 S{PLR.extruder.target-10}  ; Ожидание достижения температуры сопла
        G91                             ; Относительные координаты
        G1 Z2 F100                      ; Поднятие Z, подготовка к обнулянию X,Y
        G90                             ; Абсолютные координаты
        G28 X Y                         ; Обнуление X и Y
        M140 S{PLR.bed.target}          ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target}     ; Установка температуры сопла
        M190 S{PLR.bed.target}          ; Ожидание достижения температуры нагревательной платформы
        M109 S{PLR.extruder.target}     ; Ожидание достижения температуры сопла
        M83                             ; Относительное экструзионирование
        # G1 E0.5 F400                  ; Экструзия немного материала
    layer_count: 2 # Количество слоев для продолжения печати перед выполнением layer_change_gcode
    layer_change_gcode:                
        # GCode, выполняемый после возобновления печати после {layer_count} слоев
        M118 Возобновление скорости печати
        M106 S{PLR.fan_speed}             ; Включение вентилятора подачи материала
        M220 S{PLR.move_speed_percent}    ; Установка процентной скорости движения
        M221 S{PLR.extrude_speed_percent} ; Установка процентной скорости экструзии
    shutdown_gcode:
        # GCode, выполняемый перед выключением
        M118 Низкое напряжение питания, выключение
        # M112 ; Срочная остановка

    ```

    :::warning Внимание

    - Макрос `start_gcode` в вышеуказанном файле конфигурации может потребовать корректировки в зависимости от конкретной модели принтера.

    :::

- После сохранения данного конфигурационного файла откройте файл `printer.cfg` и добавьте в начало файла следующее содержимое:

    ```cfg

    [include plr.cfg]

    ```

- Нажмите кнопку «Сохранить» в правом верхнем углу и перезагрузите систему.
- Таким образом, функция возобновления печати после отключения питания в Klipper будет настроена.

## Тестирование

- Начните печать любого файла, во время печати нажмите кнопку «Экстренное выключение», чтобы имитировать отключение питания.
- Затем нажмите «Перезагрузка прошивки», дождитесь нормального подключения Klipper.
- Если появляется всплывающее окно на веб-интерфейсе или в KlipperScreen, это означает, что функция возобновления печати работает корректно.
- Далее можно протестировать реальное отключение питания.
  

```
