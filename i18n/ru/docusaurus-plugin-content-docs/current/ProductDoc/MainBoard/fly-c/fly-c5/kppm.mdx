---
sidebar_position: 9
---

# Возобновление печати после отключения питания в Klipper

## Общие сведения

- Возобновление печати после отключения питания в Klipper означает, что после повторного включения питания Klipper автоматически восстанавливает состояние печати.
- Для использования данной функции необходимо использовать модуль безопасного выключения.
- Не подходит для моделей принтеров, где при отключении электричества Z-ось смещается.

## Настройка

### Отключение автовыключения питания
    :::danger Важно
    - Для использования функции необходимо отключить автовыключение питания, иначе функция возобновления печати не будет работать.
    - При возобновлении печати есть функция автоматического сохранения прогресса и выключения.
    :::

- Введите IP-адрес устройства в адресную строку браузера, например: `http://192.168.6.179`
- Перейдите на страницу конфигурации
    - Откройте IP-адрес устройства в браузере, например: `http://192.168.1.2/`
    - В fluidd отключите галочку слева по образцу -> `Отключить фильтр скрытых файлов и папок`.
    - В mainsail установите галочку справа по образцу -> `Показать скрытые файлы`.
    
    <table>
      <tr>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config1.webp').default} size="100%" align="center" />
        </td>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config2.webp').default} size="85%" align="center" />
        </td>
      </tr>
    </table>

    - Теперь можно увидеть папку `.flyos-config`, перейдите в эту папку, где находится файл `sys-config.conf`.
    - Файл `sys-config.conf` является символической ссылкой на файл конфигурации `config.txt` на носителе `FlyOS-Conf`.

    <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config3.webp').default} size="60%" align="center" />

    - Откройте файл `sys-config.conf` и найдите конфигурации `shutdown_pin_state` и `shutdown_pin=`.
    - Добавьте к этим конфигурациям символ `#` в начале.
    - Сохраните изменения, закройте файл и перезагрузите систему.
    <ImageView image={require('@site/docs/General/flyos-fast/img/kppm.webp').default} size="90%" align="center" />

### Конфигурационный файл plr.cfg

- В разделе настроек принтера найдите файл `plr.cfg`.
- Очистите содержимое файла, затем вставьте следующее содержимое:
- Содержимое конфигурационного файла:

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    power_pin: !host:gpiochip0/gpio260 # Пин выключения безопасного модуля подключен к PA21 на хост-компьютере
    is_shutdown: True # Выполнять ли операцию выключения, по умолчанию включено
    paused_recover_z: -2.0 # При остановке на паузу во время печати, расстояние перемещения Z при возобновлении, по умолчанию без движения
    start_gcode:
        # G-code, выполняемый перед возобновлением печати
        # Все параметры, сохраненные до выключения, доступны через {PLR}
        # Используйте M118 {PLR} для вывода всех доступных параметров
        M118 Начало возобновления печати: {PLR.print_stats.filename}
        M118 Точка остановки: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target-10}  ; Установка температуры экструдера
        M109 S{PLR.extruder.target-10}  ; Ожидание нагрева экструдера до заданной температуры
        G91                             ; Относительная система координат
        G1 Z2 F100                      ; Поднятие Z, подготовка к нулевым точкам X,Y
        G90                             ; Абсолютная система координат
        G28 X Y                         ; Возврат к нулю X и Y
        M140 S{PLR.bed.target}          ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target}     ; Установка температуры экструдера
        M190 S{PLR.bed.target}          ; Ожидание нагрева нагревательной платформы до заданной температуры
        M109 S{PLR.extruder.target}     ; Ожидание нагрева экструдера до заданной температуры
        M83                             ; Относительное экструзионирование
        # G1 E0.5 F400                  ; Экструзия
    layer_count: 2 # Количество слоев для возобновления печати перед выполнением layer_change_gcode
    layer_change_gcode:                
        # G-code, выполняемый после возобновления печати {layer_count} слоев
        M118 Возобновление скорости печати
        M106 S{PLR.fan_speed}             ; Включение вентилятора подачи материала
        M220 S{PLR.move_speed_percent}    ; Установка процентной скорости перемещения
        M221 S{PLR.extrude_speed_percent} ; Установка процентной скорости экструзии
    shutdown_gcode:
        # G-code, выполняемый перед выключением
        M118 Низкое напряжение питания, выключение
        # M112 ; Чрезвычайная остановка

    ```

    :::warning Внимание

    - Конфигурационные макросы в файле `start_gcode` выше могут потребовать корректировки в зависимости от конкретной модели принтера.

    :::

- После сохранения вышеуказанного конфигурационного файла
- Откройте файл `printer.cfg` и добавьте в начало файла следующее содержимое:

    ```cfg

    [include plr.cfg]

    ```

- Нажмите на кнопку «Сохранить» в правом верхнем углу и перезагрузите систему.
- Таким образом, функция возобновления печати после отключения питания в Klipper настроена.

## Тестирование

- Начните печать любого файла и нажмите кнопку «Чрезвычайная остановка» во время печати, чтобы имитировать отключение питания.
- Затем нажмите кнопку «Перезагрузка прошивки» и дождитесь нормального соединения с Klipper.
- Если появляется всплывающее окно на веб-странице или в KlipperScreen, это указывает на успешную работу функции возобновления печати.
- Далее можно провести тестирование в реальных условиях отключения питания.
