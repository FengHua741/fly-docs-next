---
sidebar_position: 11
---

# Возобновление печати после отключения питания в Klipper

## Общие сведения

- Возобновление печати после отключения питания в Klipper означает, что после восстановления подачи электричества, Klipper может автоматически восстановить состояние печати.
- Для использования данной функции необходимо использовать модуль безопасного выключения.
- Не применяется для моделей принтеров, где при отключении питания Z-ось смещается.

## Настройка

### Отключение автовыключения питания
    :::danger Важно
    - Необходимо отключить автовыключение питания, иначе функция возобновления печати не будет работать.
    - В функции возобновления печати есть возможность автоматического выключения после сохранения прогресса.
    :::

- Через адресную строку браузера введите IP-адрес устройства, например: `http://192.168.6.179`
- Перейдите на страницу конфигурации
    - В браузере откройте IP-адрес устройства, например: `http://192.168.1.2/`
    - В fluidd снимите галочку слева, как показано на левом рисунке -> «Отфильтровать скрытые файлы и папки».
    - В mainsail поставьте галочку справа, как показано на правом рисунке -> «Показать скрытые файлы».
    
    <table>
      <tr>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config1.webp').default} size="100%" align="center" />
        </td>
        <td>
          <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config2.webp').default} size="85%" align="center" />
        </td>
      </tr>
    </table>

    - После этого вы увидите папку `.flyos-config`, войдите в эту папку и там будет файл `sys-config.conf`.
    - Файл `sys-config.conf` является мягким ссылкой на файл конфигурации `config.txt` в мобильном накопителе `FlyOS-Conf`.

    <ImageView image={require('@site/docs/DebugDoc/flyos-fast/img/config3.webp').default} size="60%" align="center" />

    - Откройте файл `sys-config.conf` и найдите конфигурации `shutdown_pin_state` и `shutdown_pin=`.
    - Добавьте к этим конфигурациям символ # спереди.
    - Затем сохраните изменения, закройте файл и перезагрузите устройство.
    <ImageView image={require('@site/docs/General/flyos-fast/img/kppm.webp').default} size="90%" align="center" />

### Настройка файла plr.cfg

- В разделе конфигурации принтера найдите файл `plr.cfg`.
- Очистите содержимое файла, а затем вставьте следующую конфигурацию:
- Содержимое файла конфигурации:

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    power_pin: !host:gpiochip0/gpio260 # Пин выключения безопасного модуля, подключен к выводу PA21 контроллера
    is_shutdown: True # Выполнять ли операцию выключения, по умолчанию включено
    paused_recover_z: -2.0 # Если печать была приостановлена при выключении, перемещение Z во время возобновления, по умолчанию без движения
    start_gcode:
        # G-code, выполняемый перед возобновлением печати
        # Все параметры, сохраненные перед выключением, доступны через {PLR}
        # Для вывода всех доступных параметров используйте M118 {PLR}
        M118 Начало возобновления: {PLR.print_stats.filename}
        M118 Точка останова: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target-10}  ; Установка температуры сопла
        M109 S{PLR.extruder.target-10}  ; Ожидание достижения температуры сопла
        G91                             ; Относительные координаты
        G1 Z2 F100                      ; Поднятие Z, подготовка к сбросу X,Y
        G90                             ; Абсолютные координаты
        G28 X Y                         ; Возврат к началу X,Y
        M140 S{PLR.bed.target}          ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target}     ; Установка температуры сопла
        M190 S{PLR.bed.target}          ; Ожидание достижения температуры нагревательной платформы
        M109 S{PLR.extruder.target}     ; Ожидание достижения температуры сопла
        M83                             ; Относительная экструзия
        # G1 E0.5 F400                  ; Экструзия небольшого количества материала
    layer_count: 2 # Количество слоев для продолжения печати перед выполнением layer_change_gcode
    layer_change_gcode:                
        # G-code для выполнения после продолжения печати {layer_count} слоев
        M118 Возобновление скорости печати
        M106 S{PLR.fan_speed}             ; Включение вентилятора
        M220 S{PLR.move_speed_percent}    ; Установка процентного значения скорости движения
        M221 S{PLR.extrude_speed_percent} ; Установка процентного значения скорости экструзии
    shutdown_gcode:
        # G-code, выполняемый перед выключением
        M118 Низкое напряжение питания, выключение
        # M112 ; Чрезвычайная остановка

    ```

    :::warning Внимание

    - Конфигурация файла выше может потребовать корректировки в зависимости от конкретной модели оборудования.

    :::

- Сохраните вышеуказанный файл конфигурации.
- Откройте файл `printer.cfg` и добавьте в начало файла следующее содержимое:

    ```cfg

    [include plr.cfg]

    ```

- Нажмите кнопку "Сохранить" в правом верхнем углу и перезагрузите устройство.
- Таким образом, функция возобновления печати в Klipper настроена.

## Тестирование

- Начните печать любого файла и нажмите кнопку "Чрезвычайная остановка" во время печати, чтобы имитировать отключение питания.
- После этого нажмите "Перезагрузка прошивки" и дождитесь нормального подключения Klipper.
- Если появится всплывающее окно на веб-странице или в KlipperScreen, это означает, что функция возобновления печати работает правильно.
- Можно провести дальнейшие тесты в условиях реального отключения питания.
