---
sidebar_position: 3
sidebar_label: Использование Marlin
---





# Установка **BDsensor-m-m**

## Подключите кабель датчика к разъему EXP1 на материнской плате
    *Если длина кабеля датчика недостаточна, используйте удлинитель из комплекта
    *Провода CKL и SDA датчика BDsensor-m-m можно подключать к любым выводам GPIO на плате. Также можно подключить кабель датчика BD напрямую к порту Bltouch, например:

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Input)
    GND      -->     GND
    Zmin     -->     SDA    (Input/Output) 
    ```

    *Поскольку некоторые выводы в разъемах материнской платы могут не быть напрямую подключены к GPIO MCU (например, на них могут быть установлены фильтрующие конденсаторы или изолированы через MOSFET, диод или оптопару, но если они изолированы через резисторы или резисторы с подтяжкой/подтягиванием к низкому уровню, их можно использовать), то они не могут быть использованы с BDsensor-m. И прошивка будет сообщать об ошибке подключения. Например

    *Разъемы для вентиляторов и нагревателей изолированы через MOSFET,
    *Разъемы для термисторов температуры и концевых выключателей/щупов на некоторых платах обычно подключены к GND через фильтрующие конденсаторы,

1. Как показано на рисунке, установите датчик BD рядом с экструдером. [STL of mount](https://www.thingiverse.com/thing:6098131),  [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/BDsensor-m/img/jxcs_webp.webp').default} size="100%" align="left" />



## Установите патч в прошивку Marlin

    Датчик BD интегрирован в Marlin2.1.x (с 27 августа 2022 года),

    Вы можете скачать релизную версию. Но сейчас рекомендуется скачать последнюю версию с исправлениями ошибок: https://github.com/MarlinFirmware/Marlin

    Вам нужно изменить файлы конфигурации и файлы пинов.

### Редактирование configuration.h

1. Включите BD_SENSOR

    Раскомментируйте

    ```bash
    #define BD_SENSOR
    #define Z_SAFE_HOMING
    #define BD_SENSOR_PROBE_NO_STOP //adding this new line for fast bed leveling without nozzle stop, 
    ```

    Только `BD_SENSOR_PROBE_NO_STOP`

    Последняя версия Marlin с исправлениями ошибок: https://github.com/MarlinFirmware/Marlin

    Описание: https://github.com/MarlinFirmware/Marlin/pull/25847

2. Домашний проб

    Убедитесь, что Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN отключен, и включите `USE_PROBE_FOR_Z_HOMING` как показано ниже:

    ```bash
    //#define Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN
    // Force the use of the probe for Z-axis homing
    #define USE_PROBE_FOR_Z_HOMING
    ```



3. Замедлите вторую скорость домашнего Z

    ```bash
    #define Z_PROBE_FEEDRATE_SLOW (Z_PROBE_FEEDRATE_FAST / 16)
    ```

    Здесь мы должны замедлить скорость домашнего блока и скорость домашнего Z, потому что концевой выключатель, считываемый с процесса BDsensor-m, не работает в реальном времени.

    ### Редактирование Configuration_adv.h

    `#define BABYSTEPPING` включите эту функцию для реального времени выравнивания кровати

    ```bash
    #define HOMING_BUMP_DIVISOR { 2, 2, 8 }       // Re-Bump Speed Divisor (Divides the Homing Feedrate)
    ```

### Редактирование pins_boardname.h

    Добавьте следующие 3 строки в файл пинов pins_boardname.h для конфигурации SDA и SCL датчика BDsensor-m (например): `pins_PANDA_PI_V29.h`

        ```bash
        #define  I2C_BD_SDA_PIN    PC6   // Пожалуйста, измените на фактический номер, к которому подключен провод SDA на вашей материнской плате
        #define  I2C_BD_SCL_PIN    PB2   // Пожалуйста, измените на фактический номер, к которому подключен провод SLK на вашей материнской плате
        #define  I2C_BD_DELAY  20      // Значение по умолчанию 20, должно быть в диапазоне [20,50].
        ```

    Если вы хотите сделать автоматическую настройку кровати перед печатью как с обычным BLtouch (G29), раскомментируйте

        ```bash
        #define AUTO_BED_LEVELING_BILINEAR
        ```

    и отредактируйте значения следующим образом:

        ```bash
        #define Z_CLEARANCE_DEPLOY_PROBE   0 // Очистка Z для развертывания/свертывания
        #define Z_CLEARANCE_BETWEEN_PROBES  1 // Очистка Z между точками зондирования
        #define Z_CLEARANCE_MULTI_PROBE     1 // Очистка Z между несколькими зондированиями
        ```



## Отображение значений датчика BD на ЖК-дисплее

    *Для принтера с отображением статуса (поддерживающим gcode M117), например, LCD12864 или некоторые UART-экраны, например, ender3V2 ...

## Калибровка

    1. Очистите сопло, затем переместите ось Z через консоль, пока сопло не коснется кровати (BDsensor-m использует эту позицию как точку 0, поэтому z_offset не нужен, установите значение на 0).
    2. Отправьте команду gcode `M102 S-6`, принтер будет медленно поднимать ось Z на 0.1 мм, пока не достигнет 4 мм. Не запускайте M102 S-6 до установки датчика, также не выключайте принтер во время калибровки, иначе старые данные калибровки будут удалены. В этом случае просто снова откалибруйте.

    3. Вы можете отправить `M102 S-5` для проверки успешности калибровки датчика BD, это вернет исходные данные калибровки, сохраненные в датчике BD.

    Также есть инструмент калибровки, который может это сделать: https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip ![img](https://raw.githubusercontent.com/markniu/Bed_Distance_sensor/main/doc/images/Read.jpg)

    Внимание: Значение данных 1015 или > 1010 означает, что датчик вышел за пределы диапазона. Если первые 5 точек (0~0.5 мм) или больше находятся в диапазоне от 0 до 1000 и увеличение значений delta составляет >=10, это означает успешную калибровку. Как показано на графике выше.

    Если M102 S-5 возвращает первые исходные данные калибровки больше 400, это означает, что датчик установлен слишком высоко, и его нужно установить ближе к кровати. Также убедитесь, что второе значение больше первого на 10 и более.

## Тестирование и печать

    Меню кровати

    Автоматическое выравнивание кровати

## Существует два способа автоматического выравнивания кровати:

    **1. Использование M102 для реального времени выравнивания первых нескольких слоев**

        Мы можем легко включить или отключить это автоматическое выравнивание, отправив gcode команду или добавив gcode в файл gcode.

        Чтобы включить выравнивание кровати в Cura, добавьте gcode M102 (домашний для всех осей) под gcode G102 в разделе "Начальный G-код" настроек машины принтера. Например, под G28, это означает, что выравнивание кровати будет производиться только на высоте Z до 0.2 мм. `M102 S2`

        Отправка или использование датчика BD для отключения выравнивания кровати, кстати, по умолчанию отключено. `M102 S0``G28``M18`

        ```bash
        M102   S-1     //Прочитать информацию о датчике, мы можем использовать это для проверки соединения.
        M102   S-2     //Прочитать текущее значение расстояния
        M102   S-5     //Прочитать исходные данные калибровки
        M102   S-6     //Начать калибровку, перед этим убедитесь, что сопло только коснулось кровати, затем перезапустите принтер. Не домашняя ось Z перед этим.
        M102   S4      //Установить значение регулируемой высоты Z, например, M102 S4 означает, что регулировка будет производиться, пока высота Z <=0.4 мм, отключить с помощью M102 S0.
        ```

    **2. G29 автоматическое выравнивание кровати**

        Другой способ автоматического выравнивания кровати, как с G29 BLtouch, просто добавьте строку G28 под G29.

        [Видео установки](https://www.pandapi3d.com/post/install-bed-distance-sensor-video)

        [Видео установки от Chris Basement](https://youtu.be/VLUfvkO2NFc?si=PF_6nhw39KhHBhcj)

### Проверка концевика Z `M119`

    Не домашняя ось Z перед проверкой этого шага, иначе сопло может удариться о кровать.

    Это сообщение, возвращаемое после отправки команды M119 (сообщение о состоянии концевых выключателей).

    ```bash
    Send: M119
    Recv: x:open y:open z:open
    ```

    Если z min не открыт, проверьте вашу конфигурацию. `#define Z_MAX_ENDSTOP_HIT_STATE HIGH`

    - Убедитесь, что двигатель Z отключен/разблокирован
    - Вручную опустите ось Z, пока сопло не коснется кровати
    - Отправьте `M102 S-2`, возвращаемое значение должно быть 0.00 мм, затем снова отправьте M119, можно увидеть, что концевик z теперь сработал.

    ```bash
    Send: M119
    Recv: x:open y:open z:TRIGGERED
    ```

    ### Проверка соединения

    Проверьте соединение через `M102 S-1`. Это пример возвращаемого сообщения, проверьте, не возвращается ли пустая строка или другая строка.

    ```bash
    Send: M102 S-1
    Recv: V1.0 pandapi3d.com
    ```



## Если все вышеперечисленные шаги выполнены правильно, теперь вы можете домашний ось Z.

