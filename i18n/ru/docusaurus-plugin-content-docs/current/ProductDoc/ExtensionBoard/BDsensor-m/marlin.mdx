---
sidebar_position: 3
sidebar_label: Использование Marlin
---

# Установка **BDsensor-m-m**

## Подключите кабель датчика к разъему EXP1 на материнской плате
    *Если кабель датчика слишком короткий, используйте удлинитель из комплекта
    * Провода CKL и SDA датчика BDsensor-m-m можно подключить к любым GPIO-контактам на плате. Вы также можете подключить кабель датчика BD напрямую к порту Bltouch, например:

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Вход)
    GND      -->     GND
    Zmin     -->     SDA    (Вход/Выход) 
    ```

    * Из-за того, что некоторые контакты в разъеме материнской платы могут не быть напрямую подключены к GPIO MCU (например, на них могут быть установлены фильтрующие конденсаторы или изолированы через MOSFET, диоды или оптопары, но если они изолированы через резисторы или резисторы с подтяжкой/опусканием, это также допустимо), они не могут использоваться вместе с BDsensor-m. И прошивка будет сообщать об ошибке подключения. Например

    * Коннекторы вентиляторов и нагревателей изолированы через MOSFET,
    * Коннекторы для термисторов и концевых выключателей/датчиков в некоторых платах обычно подключены к GND через фильтрующие конденсаторы,

1. Как показано на рисунке, установите датчик BD вблизи горячего конца. [STL крепления](https://www.thingiverse.com/thing:6098131),  [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/BDsensor-m/img/jxcs_webp.webp').default} size="100%" align="left" />



## Установка патча в прошивку Marlin

    Датчик BD интегрирован в Marlin2.1.x (с 27.08.2022),

    Вы можете скачать релизную версию. Но сейчас рекомендуется скачать последнюю версию с исправлениями ошибок: https://github.com/MarlinFirmware/Marlin

    Вам нужно изменить файлы конфигурации и файлы пинов.

### Редактирование config.h

1. Включение BD_SENSOR

    Раскомментируйте

    ```bash
    #define BD_SENSOR
    #define Z_SAFE_HOMING
    #define BD_SENSOR_PROBE_NO_STOP //добавление этой новой строки для быстрой настройки уровня без остановки сопла, 
    ```

    Только `BD_SENSOR_PROBE_NO_STOP`

    Последние исправления Marlin: https://github.com/MarlinFirmware/Marlin

    Описание: https://github.com/MarlinFirmware/Marlin/pull/25847

2. Использование зонда для возвращения в домашнее положение

    Убедитесь, что Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN отключен, и включите `USE_PROBE_FOR_Z_HOMING` как показано ниже

    ```bash
    //#define Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN
    // Force the use of the probe for Z-axis homing
    #define USE_PROBE_FOR_Z_HOMING
    ```



3. Замедление второй скорости возвращения в домашнее положение по оси Z

    ```bash
    #define Z_PROBE_FEEDRATE_SLOW (Z_PROBE_FEEDRATE_FAST / 16)
    ```

    Здесь мы должны замедлить скорость возвращения в домашнее положение для бампера и оси Z, так как концевой выключатель, считываемый процессом BDsensor-m, не работает в реальном времени, как обычный концевой выключатель.

    ### Редактирование Configuration_adv.h

    Включите функцию `#define BABYSTEPPING` для обеспечения возможности реального времени выравнивания

    ```bash
    #define HOMING_BUMP_DIVISOR { 2, 2, 8 }       // Re-Bump Speed Divisor (Divides the Homing Feedrate)
    ```

### Редактирование pins_boardname.h

    Настройте пины SDA и SCL для BDsensor-m в файле пинов pins_boardname.h, добавив следующие 3 строки (например, для `pins_PANDA_PI_V29.h`):

        ```bash
        #define  I2C_BD_SDA_PIN    PC6   // Пожалуйста, измените на фактический номер, к которому подключен провод SDA на вашей материнской плате
        #define  I2C_BD_SCL_PIN    PB2   // Пожалуйста, измените на фактический номер, к которому подключен провод SLK на вашей материнской плате
        #define  I2C_BD_DELAY  20      // значение по умолчанию равно 20, должно быть в диапазоне [20,50].
        ```

    Если вы хотите выполнить автоматическое выравнивание стола перед печатью, как это делает обычный BLtouch (G29), раскомментируйте

        ```bash
        #define AUTO_BED_LEVELING_BILINEAR
        ```

    и отредактируйте значения как показано ниже

        ```bash
        #define Z_CLEARANCE_DEPLOY_PROBE   0 // Зазор по Z для развертывания/сворачивания зонда
        #define Z_CLEARANCE_BETWEEN_PROBES  1 // Зазор по Z между точками зондирования
        #define Z_CLEARANCE_MULTI_PROBE     1 // Зазор по Z между многократными зондированиями
        ```



## Отображение значений BD-датчика на экране

    * Для принтеров с экраном состояния (поддерживают gcode M117), например, LCD12864 или некоторые экраны UART, такие как Ender3V2 ...

## Калибровка

    1. Очистите сопло, затем через консоль переместите ось Z, пока сопло не коснется стола (BDsensor-m будет использовать эту позицию как точку 0, поэтому z_offset не нужен, установите значение на 0).
    2. Отправьте команду gcode `M102 S-6`, принтер будет медленно поднимать ось Z на 0.1мм, пока не достигнет 4мм. Не запускайте M102 S-6 до установки датчика, и не выключайте принтер во время калибровки, иначе старые данные калибровки будут удалены. В таком случае просто повторите калибровку

    3. Вы можете отправить `M102 S-5` для проверки успешности калибровки BD-датчика, это вернет сохраненные в BD-датчике исходные данные калибровки.

    Существует также инструмент калибровки, который может выполнить эту задачу: https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip ![img](https://raw.githubusercontent.com/markniu/Bed_Distance_sensor/main/doc/images/Read.jpg)

    Примечание: значение данных 1015 или > 1010 означает, что датчик находится вне диапазона. Если первые 5 точек (0~0.5мм) или больше имеют значения в диапазоне от 0 до 1000, и значения увеличиваются на delta >=10, это означает успешную калибровку. Как показано на диаграмме выше.

    Если M102 S-5 возвращает первое значение исходных данных калибровки больше 400, это означает, что датчик установлен слишком высоко, его нужно переустановить ближе к столу. Также убедитесь, что второе значение больше первого на 10 и более.

## Тестирование и печать

    Меню выравнивания стола

    Автоматическое выравнивание стола

## Существует два способа автоматического выравнивания стола:

    **1. Использование M102 для реального времени выравнивания первых нескольких слоев**

        Мы можем легко включить или отключить эту функцию, отправляя команду gcode или добавляя её в файл gcode.

        Чтобы включить выравнивание стола в Cura, добавьте команду M28 в разделе "Стартовый G-код" настроек машины принтера сразу после команды G102 (возвращение всех осей в домашнее положение). Например, ниже G28, что означает, что выравнивание стола будет выполнено только при высоте Z меньше 0.2мм. `M102 S2`

        Отправка или использование BD-датчика для отключения выравнивания стола, кстати, по умолчанию отключено. `M102 S0``G28``M18`

        ```bash
        M102   S-1     //Чтение информации с датчика, мы можем использовать это для проверки соединения.
        M102   S-2     //Чтение текущего значения расстояния
        M102   S-5     //Чтение исходных данных калибровки
        M102   S-6     //Начало калибровки, перед этим убедитесь, что сопло только коснулось стола, а затем перезапустите принтер. Не возвращайте ось Z в домашнее положение перед этим.
        M102   S4      //Установка регулируемого значения высоты Z, например, M102 S4 означает, что корректировка будет выполнена, если высота Z <=0.4мм, отключить её можно командой M102 S0.
        ```

    **2. G29 автоматическое выравнивание стола**

        Другой способ автоматического выравнивания стола, как у G29 для BLtouch, просто добавьте строку G28 под G29.

        [Видео установки](https://www.pandapi3d.com/post/install-bed-distance-sensor-video)

        [Видео установки от Chris Basement](https://youtu.be/VLUfvkO2NFc?si=PF_6nhw39KhHBhcj)

### Проверка концевого выключателя Z `M119`

    Перед выполнением этого шага не возвращайте ось Z в домашнее положение, иначе сопло может удариться о стол принтера.

    Это сообщение, которое вы получите после отправки команды M119 (сообщение о состоянии концевых выключателей).

    ```bash
    Send: M119
    Recv: x:open y:open z:open
    ```

    Если z min не открыт, проверьте вашу конфигурацию. `#define Z_MAX_ENDSTOP_HIT_STATE HIGH`

    - Убедитесь, что двигатель оси Z отключен/разблокирован
    - Вручную опустите ось Z, пока сопло не коснется стола
    - Отправьте `M102 S-2`, возвращаемое значение должно быть 0.00мм, затем снова отправьте M119, можно увидеть, что концевой выключатель z теперь сработал.

    ```bash
    Send: M119
    Recv: x:open y:open z:TRIGGERED
    ```

    ### Проверка соединения

    Проверьте соединение через `M102 S-1`. Вот пример возвращаемого сообщения, убедитесь, что соединение и порядок проводов возвращает пустую строку или другую строку.

    ```bash
    Send: M102 S-1
    Recv: V1.0 pandapi3d.com
    ```



## Если все вышеперечисленные шаги выполнены правильно, то теперь вы можете вернуть ось Z в домашнее положение.

