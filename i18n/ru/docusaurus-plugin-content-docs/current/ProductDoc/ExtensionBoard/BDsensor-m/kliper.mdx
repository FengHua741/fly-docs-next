---
sidebar_position: 3
sidebar_label: Использование Klipper
---





# Установка **BDsensor-m**

## Подключите кабель датчика к разъему EXP1 на материнской плате
    * Если кабель датчика слишком короткий, можно использовать удлинительный кабель из упаковки
    * Провода CKL и SDA у BDsensor-m могут быть подключены к любым GPIO-пинам на плате. Вы также можете подключить кабель датчика BD непосредственно к порту Bltouch, например:

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Вход)
    GND      -->     GND
    Zmin     -->     SDA    (Вход/Выход) 
    ```

    * Из-за того, что некоторые контакты в разъемах материнской платы могут не быть напрямую подключены к GPIO MCU (например, они могут иметь фильтрующие конденсаторы или быть изолированы через MOSFET, диод или оптопару, но если они изолированы через резистор или резистор с подтяжкой/оттяжкой, это допустимо), они не могут использоваться вместе с `BDsensor-m`. И прошивка будет сообщать об ошибке подключения. Например
    * Коннекторы для вентиляторов и нагревателей изолированы через MOSFET,
    * Некоторые платы для термисторов температуры и концевых выключателей/датчиков обычно подключены через фильтрующие конденсаторы к GND,

1. Как показано на рисунке, установите датчик BD рядом с хотэндом. [STL of mount](https://www.thingiverse.com/thing:6098131),  [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/BDsensor-m/img/jxcs_webp.webp').default} size="100%" align="left" />


## Установите патч в прошивку Klipper

    * Откажитесь от ранее измененных файлов Klipper и обновите Klipper

        ```bash
        cd
        cd ~/klipper
        git checkout .
        git pull
        ```

    * Клонируйте последний код датчика BD

        ```bash
        cd && git clone https://github.com/markniu/Bed_Distance_sensor.git
        ```

    * Установите

        ```bash
        cd  ~/Bed_Distance_sensor/klipper/
        ./install_BDsensor.sh
        ```

    * Скомпилируйте прошивку

        ```bash
        cd ~/klipper/
        make menuconfig
        make clean
        make
        ```

    * Запишите прошивку на материнскую плату, к которой подключен датчик BD

## Если ваш принтер работает на Moonraker, добавьте следующую часть в файл moonraker.conf, затем вы сможете обновить BDsensor одним щелчком через веб-страницу или klipperscreen.

    ```bash
    [update_manager BDsensor]
    type: git_repo
    primary_branch: new
    channel: dev
    path: ~/Bed_Distance_sensor
    origin: https://github.com/markniu/Bed_Distance_sensor.git
    install_script: ./klipper/install_BDsensor.sh
    is_system_service: False
    managed_services: klipper
    info_tags:
    desc=Bed Distance Sensor
    ```

## Редактирование printer.cfg

    * Скопируйте эту часть в ваш **printer.cfg** и отредактируйте `sda_pin` и `scl_pin` в `[BDsensor]`, не забудьте также отключить другие части датчиков, например **BLtouch**. Вы можете подключить датчик BD к материнской плате или модулю CAN на инструменте,
    * В `[BDsensor]` измените значение `speed` на 0.8. Это применяется только для команд z_tilt и PROBE_ACCURACY. Чем меньше значение, тем выше точность при зондировании, поскольку MCU читает датчик BD в главном цикле не так реально, как обычный концевой выключатель. `[BDsensor]`
    * Для использования датчика BD в качестве концевого выключателя при возврате оси Z измените `endstop_pin` в `[stepper_z]` на `endstop_pin: probe:z_virtual_endstop`
    * Убедитесь, что в **printer.cfg** есть `[safe_z_home]` 
    * Измените значение в `[bed_mesh]` и `[z_tilt]` или `[quad_gantry_level]` на 1 (рекомендуется от 0.7 до 1.0 мм), по умолчанию в Klipper это 5 мм, иначе возможно превышение диапазона датчика
    * **Высота сопла должна быть настроена только в `z_adjust:`, положительное значение приближает сопло к кровати, отрицательное значение отдаляет, другие настройки высоты сопла могут вызвать ошибки**
    * Чтобы включить быстрое сканирование кровати, удалите # перед `no_stop_probe:true`
    * Вот пример конфигурации.

        ```cfg
        [BDsensor] 
        scl_pin:PC6  # Пин для сигнала сервопривода
        sda_pin:PC3  # Пин для сигнала концевого выключателя
        delay: 20 # 20 микросекунд на импульс, это значение должно быть >=20, но не более 50
        z_offset:0 # это `z_offset` должно быть установлено на 0. 
        z_adjust:0.0 # корректировка оси Z, заменяет функцию z_offset. в пределах от -0.3 до 0.3 мм
        x_offset: -34
        y_offset: 0
        #no_stop_probe:true # включите это для быстрого зондирования, головка не будет останавливаться на точке зондирования.
        position_endstop: 0.8 # ось Z остановится на этой позиции (мм) при возврате в ноль, рекомендуемое значение от 0.4 до 1.0
        #speed:0.8 # это значение скорости действует только для команд z tilt и PROBE_ACCURACY.

        [stepper_z]
        endstop_pin: probe:z_virtual_endstop 
        #position_endstop: 0.5
        homing_speed: 5
        second_homing_speed: 0.8

        [bed_mesh]
        speed: 200
        horizontal_move_z:1
        algorithm: bicubic

        [quad_gantry_level]
        horizontal_move_z:1

        ```

## После установки проверьте, отправив следующие команды gcode

    ```bash
    M102   S-1     # Чтение информации с датчика
    M102   S-2     # Чтение одного значения расстояния
    ```

## Проверка подключения

    * Отправьте через **консоль** команду `M102 S-1`. Это пример возвращаемого сообщения, если возвращается пустое сообщение или другой текст, проверьте подключение и порядок проводов.

        ```bash
        Send: M102 S-1
        Recv: V1.0 pandapi3d.com
        ```

## Калибровка

    * Очистите сопло, затем через консоль переместите ось Z до тех пор, пока сопло не коснется кровати (BDsensor-m будет использовать эту позицию как нулевую, поэтому `z_offset` не нужен, это причина, почему значение в разделе [BDsensor-m] равно 0)
    * Отправьте через **консоль** команду `M102 S-6`, принтер будет медленно перемещать ось Z вверх на 0.1 мм до достижения 4 мм. Не запускайте M102 S-6 до установки датчика, и не выключайте принтер во время калибровки, иначе старые данные калибровки будут удалены. Если это произошло, просто повторите калибровку.
    * Затем вы можете проверить, была ли калибровка успешной с помощью `M102 S-5`, это вернет исходные данные калибровки, сохраненные в датчике BD.

**Примечания**:

* Лучшая скорость возврата оси Z - 5

* Если M102 S-5 возвращает первое значение исходных данных калибровки больше 400, это означает, что датчик установлен слишком высоко, его нужно установить ближе к кровати, рекомендуемое значение первого параметра - 100. Также убедитесь, что второе значение больше первого на 10 и выше.

  * FAQ: Если данные калибровки начинаются с 1, второе значение - 9, а третье - 24, что это значит?

  * Это означает, что разрешение на расстоянии от 0 до 0.1 мм составляет только 9, а на расстоянии от 0.1 до 0.2 мм - 15. Поэтому рекомендуется провести калибровку заново, чтобы первое разрешение 0-0.1 мм было больше 10.

* Не забывайте после выполнения G28 или для этих команд `Z_tilt` и `quad_gantry_level` корректировать высоту оси Z

* Названия частей должны быть правильно написаны с учетом регистра, иначе Klipper сообщит об ошибке `Unknown pin chip name 'probe'`