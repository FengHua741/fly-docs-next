---
sidebar_position: 3
sidebar_label: Использование Klipper
---





# Установка **BDsensor-m**

## Подключите кабель датчика к порту EXP1 на материнской плате
    * Если кабель датчика слишком короткий, используйте удлинительный кабель из комплекта
    * Линии CKL и SDA датчика BDsensor-m можно подключить к любому GPIO на плате. Также можно подключить кабель датчика BD напрямую к порту Bltouch, например:

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Вход)
    GND      -->     GND
    Zmin     -->     SDA    (Вход/Выход) 
    ```

    * Некоторые выводы в коннекторе материнской платы могут не быть непосредственно подключены к GPIO MCU (например, они могут быть подключены через фильтрующие конденсаторы, изолированы через MOSFET, диоды или оптопары, но если они изолированы через резисторы или резисторы с подтяжкой/подтягиванием, это тоже подойдет), поэтому их нельзя использовать с `BDsensor-m`. И прошивка сообщит об ошибке соединения. Например:
    * Коннекторы для вентиляторов и нагревателей изолированы через MOSFET,
    * В некоторых платах коннекторы для термисторов и концевиков/датчиков обычно подключены к GND через фильтрующие конденсаторы,

1. Установите датчик BD поближе к экструдеру, как показано на рисунке. [STL крепления](https://www.thingiverse.com/thing:6098131),  [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/bd-sensor/img/bd.webp').default} size="100%" align="left" />


## Установка патча в прошивку Klipper

    * Отмените предыдущие изменения в файлах Klipper и обновите Klipper

        ```bash
        cd
        cd ~/klipper
        git checkout .
        git pull
        ```

    * Клонируйте последний код датчика BD

        ```bash
        cd && git clone https://github.com/markniu/Bed_Distance_sensor.git
        ```

    * Установка

        ```bash
        cd  ~/Bed_Distance_sensor/klipper/
        ./install_BDsensor.sh
        ```

    * Сборка прошивки

        ```bash
        cd ~/klipper/
        make menuconfig
        make clean
        make
        ```

    * Загрузите прошивку на материнскую плату, к которой подключен датчик BD

## Если ваш принтер работает под управлением Moonraker, добавьте следующий раздел в moonraker.conf, и вы сможете обновлять BDsensor одним щелчком через веб-интерфейс или Klipperscreen.

    ```bash
    [update_manager BDsensor]
    type: git_repo
    primary_branch: new
    channel: dev
    path: ~/Bed_Distance_sensor
    origin: https://github.com/markniu/Bed_Distance_sensor.git
    install_script: ./klipper/install_BDsensor.sh
    is_system_service: False
    managed_services: klipper
    info_tags:
    desc=Bed Distance Sensor
    ```

## Редактирование printer.cfg

    * Скопируйте этот раздел в ваш **printer.cfg** и отредактируйте `sda_pin` и `scl_pin` в `[BDsensor]`, не забудьте также отключить другие датчики, такие как **BLtouch**. Вы можете подключить датчик BD к материнской плате или к модулю CAN на головке инструмента,
    * В `[BDsensor]` измените `speed` на 0.8. Это применимо только для команд z tilt и PROBE_ACCURACY. Чем меньше значение, тем выше точность при зондировании, так как MCU читает датчик BD в основном цикле не так реактивно, как обычный концевик. `[BDsensor]`
    * Для использования датчика BD в качестве концевика при возврате Z-оси, измените `endstop_pin` в `[stepper_z]` на `endstop_pin: probe:z_virtual_endstop`
    * Убедитесь, что в **printer.cfg** есть `[safe_z_home]` 
    * Измените значение в `[bed_mesh]` и `[z_tilt]` или `[quad_gantry_level]` на 1 (рекомендуется 0.7-1.0 мм), по умолчанию в Klipper это 5 мм, иначе легко выйти за пределы диапазона датчика
    * **Высота сопла должна быть настроена только через `z_adjust:`, положительное значение приближает к платформе, отрицательное - отдаляет, другие настройки для высоты сопла могут вызвать ошибки**
    * Для активации быстрого зондирования удалите символ `#` перед `no_stop_probe:true`
    * Пример конфигурации:

        ```cfg
        [BDsensor] 
        scl_pin:PC6  # Вывод для сигнала сервопривода
        sda_pin:PC3  # Вывод для сигнала концевика
        delay: 20 # 20us на импульс, это значение должно быть >=20, но не более 50
        z_offset:0 # это значение `z_offset` должно быть установлено на 0. 
        z_adjust:0.0 # корректировка оси Z, заменяет функцию z_offset. в пределах -0.3 до 0.3 мм
        x_offset: -34
        y_offset: 0
        #no_stop_probe:true # активируйте это для быстрого зондирования, головка инструмента не будет останавливаться на точке зондирования.
        position_endstop: 0.8 # ось Z остановится на этой позиции (мм) при возврате оси Z, рекомендуемое значение от 0.4 до 1.0
        #speed:0.8 # эта скорость работает только для команд z tilt и PROBE_ACCURACY.

        [stepper_z]
        endstop_pin: probe:z_virtual_endstop 
        #position_endstop: 0.5
        homing_speed: 5
        second_homing_speed: 0.8

        [bed_mesh]
        speed: 200
        horizontal_move_z:1
        algorithm: bicubic

        [quad_gantry_level]
        horizontal_move_z:1

        ```

## После установки проверьте, отправив следующие команды G-code:

    ```bash
    M102   S-1     # Чтение информации с датчика
    M102   S-2     # Чтение одного значения расстояния
    ```

## Проверка соединения

    * Отправьте команду `M102 S-1` через **консоль**, это пример возвращаемого сообщения, если возвращается пустое значение или другая строка, проверьте соединение и порядок проводов

        ```bash
        Send: M102 S-1
        Recv: V1.0 pandapi3d.com
        ```

## Калибровка

    * Очистите сопло, затем через консоль переместите ось Z, пока сопло едва не коснется платформы (BDsensor-m будет использовать эту позицию как нулевую, поэтому не требуется `z_offset`, вот почему значение в разделе [BDsensor-m] равно 0)
    * Отправьте команду G-code `M102 S-6` через **консоль**, принтер будет медленно поднимать ось Z на 0.1 мм каждый раз, пока не достигнет 4 мм. Не запускайте M102 S-6 до установки датчика, и не выключайте принтер во время калибровки, иначе старые данные калибровки будут удалены. В таком случае просто калибруйте снова
    * После этого вы можете проверить, успешно ли прошла калибровка датчика BD, отправив `M102 S-5`, что вернет исходные данные калибровки, сохраненные в датчике BD.

**Примечания**:

* Лучше всего установить скорость возврата оси Z на 5

* Если M102 S-5 возвращает первое исходное значение калибровки больше 400, это означает, что датчик установлен слишком высоко и его нужно установить ближе к платформе, рекомендуемое значение для первого параметра - 100. Также убедитесь, что второе значение больше первого на 10 и более

  * Вопросы и ответы: Если данные калибровки начинаются с 1, второе значение - 9, а третье - 24, что это значит?

  * Это означает, что разрешение между 0-0.1 мм составляет всего 9, а разрешение между 0.1-0.2 мм - 15. Рекомендуется повторить калибровку, чтобы первое разрешение 0-0.1 мм было больше 10.

* Не забудьте отрегулировать высоту оси Z после выполнения G28 или для команд `Z_tilt` и `quad_gantry_level`

* Имена разделов должны быть правильно написаны с учетом регистра, иначе Klipper сообщит об ошибке `Unknown pin chip name 'probe'`