---
sidebar_position: 3
sidebar_label: Использование Klipper
---





# Установка **BDsensor-m**

## Подключите кабель датчика к разъему EXP1 на материнской плате
    * Если кабель датчика недостаточно длинный, используйте удлинительный кабель из комплекта
    * Линии CKL и SDA BDsensor-m могут быть подключены к любым GPIO-контакты на плате. Вы также можете подключить кабель датчика BD напрямую к порту Bltouch, например:

    ```bash
    BLtouch    |    BDsensor-m
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Вход)
    GND      -->     GND
    Zmin     -->     SDA    (Вход/Выход) 
    ```

    * Некоторые контакты в разъемах на материнской плате могут быть не напрямую подключены к GPIO MCU (например, через фильтрующие конденсаторы или через MOSFET, диоды или оптопары, но если они изолированы через резисторы или подтяжку/оттяжку резисторов, это также возможно), поэтому их нельзя использовать с `BDsensor-m`. И прошивка сообщит об ошибке подключения. Например,
    * Разъемы для вентиляторов и нагревателей изолированы через MOSFET,
    * Разъемы для термисторов и концевых выключателей/датчиков на некоторых платах обычно подключены к GND через фильтрующие конденсаторы,

1. Как показано на рисунке, установите датчик BD рядом с хотэндом. [STL of mount](https://www.thingiverse.com/thing:6098131),  [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/BDsensor-m/img/jxcs_webp.webp').default} size="100%" align="left" />


## Установите патч в прошивку Klipper

    * Откажитесь от предыдущих изменений файлов Klipper и обновите Klipper

        ```bash
        cd
        cd ~/klipper
        git checkout .
        git pull
        ```

    * Клонируйте последний код датчика BD

        ```bash
        cd && git clone https://github.com/markniu/Bed_Distance_sensor.git
        ```

    * Установка

        ```bash
        cd  ~/Bed_Distance_sensor/klipper/
        ./install_BDsensor.sh
        ```

    * Компиляция прошивки

        ```bash
        cd ~/klipper/
        make menuconfig
        make clean
        make
        ```

    * Запишите прошивку на материнскую плату, к которой подключен датчик BD

## Если ваш принтер работает на Moonraker, добавьте следующий раздел в moonraker.conf, затем вы сможете обновить BDsensor одним кликом через веб-интерфейс или klipperscreen.

    ```bash
    [update_manager BDsensor]
    type: git_repo
    primary_branch: new
    channel: dev
    path: ~/Bed_Distance_sensor
    origin: https://github.com/markniu/Bed_Distance_sensor.git
    install_script: ./klipper/install_BDsensor.sh
    is_system_service: False
    managed_services: klipper
    info_tags:
    desc=Bed Distance Sensor
    ```

## Редактирование printer.cfg

    * Скопируйте этот раздел в ваш **printer.cfg** и отредактируйте `sda_pin` и `scl_pin` в `[BDsensor]`, также не забудьте отключить другие датчики, такие как **BLtouch**. Вы можете подключить датчик BD к материнской плате или модулю CAN на инструментальной головке, 
    * В `[BDsensor]` измените `speed` на 0.8. Это применимо только к командам Z TILT и PROBE_ACCURACY. Чем меньше значение, тем выше точность при зондировании, так как MCU читает датчик BD в главном цикле не так, как обычный концевой выключатель в реальном времени. `[BDsensor]`
    * Чтобы использовать датчик BD в качестве концевого выключателя при возврате по оси Z, измените `endstop_pin` в `[stepper_z]` на `endstop_pin: probe:z_virtual_endstop`
    * Убедитесь, что в **printer.cfg** есть `[safe_z_home]` 
    * Измените значение в `[bed_mesh]` и `[z_tilt]` или `[quad_gantry_level]` на 1 (рекомендуется 0.7-1.0mm), так как по умолчанию в Klipper это 5mm, что может выйти за пределы диапазона датчика
    * **Высота сопла должна быть настроена только в `z_adjust:`, положительное значение приближает к столу, отрицательное - отдаляет, другие настройки высоты сопла могут вызвать ошибки**
    * Для активации быстрого сканирования стола удалите символ # перед `no_stop_probe:true`
    * Пример конфигурации приведен ниже.

        ```cfg
        [BDsensor] 
        scl_pin:PC6  # Порт для сервопривода
        sda_pin:PC3  # Порт для концевого выключателя
        delay: 20 # 20 мкс на импульс, это значение должно быть >=20, но меньше 50
        z_offset:0 # это `z_offset` должно быть установлено на 0. 
        z_adjust:0.0 # корректировка по оси Z, заменяет функцию z_offset. в пределах от -0.3 до 0.3 мм
        x_offset: -34
        y_offset: 0
        #no_stop_probe:true # активируйте это для быстрого зондирования, головка инструмента не будет останавливаться в точке зондирования.
        position_endstop: 0.8 # ось Z остановится в этой позиции (мм) при возврате по Z, рекомендуемое значение от 0.4 до 1.0
        #speed:0.8 # эта скорость действует только для команд z tilt и PROBE_ACCURACY.

        [stepper_z]
        endstop_pin: probe:z_virtual_endstop 
        #position_endstop: 0.5
        homing_speed: 5
        second_homing_speed: 0.8

        [bed_mesh]
        speed: 200
        horizontal_move_z:1
        algorithm: bicubic

        [quad_gantry_level]
        horizontal_move_z:1

        ```

## После установки, проверьте, отправив следующие команды G-code

    ```bash
    M102   S-1     # Чтение информации с датчика
    M102   S-2     # Чтение одного значения расстояния
    ```

## Проверка подключения

    * Отправьте через **консоль** `M102 S-1`, вот пример возвращаемого сообщения, если возвращается пусто или другая строка, проверьте подключение и порядок проводов

        ```bash
        Send: M102 S-1
        Recv: V1.0 pandapi3d.com
        ```

## Калибровка

    * Очистите сопло, затем через консоль переместите ось Z, пока сопло не коснется стола (BDsensor-m использует эту позицию как нулевую, поэтому `z_offset` не нужен, вот почему в разделе [BDsensor-m] значение равно 0)
    * Отправьте через **консоль** команду G-code `M102 S-6`, принтер будет медленно поднимать ось Z на 0.1 мм до достижения 4 мм. Не запускайте M102 S-6 до установки датчика, также не выключайте принтер во время калибровки, иначе старые данные калибровки будут удалены. В этом случае просто выполните калибровку снова
    * После этого вы можете проверить, успешно ли прошла калибровка датчика BD, отправив `M102 S-5`, что вернет исходные данные калибровки, сохраненные в датчике BD.

**Примечания**:

* Лучше всего установить скорость возврата по оси Z на 5

* Если M102 S-5 возвращает первое исходное значение калибровки больше 400, это означает, что датчик установлен слишком высоко и его нужно переставить ближе к столу, рекомендуемое значение первого данных - 100. Также убедитесь, что значение второго данных больше первого на 10 и более

  * FAQ: Что означает, если данные калибровки начинаются с 1, второе значение - 9, третье - 24?

  * Это означает, что разрешение между 0-0.1 мм составляет только 9, а разрешение между 0.1-0.2 мм - 15. Поэтому рекомендуется повторить калибровку, чтобы первое разрешение 0-0.1 мм было больше 10.

* Не забывайте корректировать высоту оси Z после выполнения G28 или для команд `Z_tilt` и `quad_gantry_level`

* Имена разделов должны быть правильно написаны с учетом регистра, иначе Klipper сообщит об ошибке `Unknown pin chip name 'probe'`