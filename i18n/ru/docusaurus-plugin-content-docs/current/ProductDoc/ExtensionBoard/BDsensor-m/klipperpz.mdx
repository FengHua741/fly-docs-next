---
sidebar_position: 4
sidebar_label: Автоматическая корректировка Z-OFFSET в Klipper
---

# Установка автоматической обработки столкновения с дюзой в Klipper

:::info
Эта функция требует версии прошивки BD-сенсора V1.1b или выше (версию можно проверить отправкой команды M102 S-1, а не по версии на аппаратном уровне), либо версию, приобретенную после марта 2024 года. Если требования не выполняются, потребуется использование внешнего оборудования (например, STlink) для обновления прошивки BD-сенсора.

При проведении процедуры калибровки с использованием мягкого PEI (например, Whambam) не рекомендуется нагревать сопло слишком сильно, так как высокая температура может оставить отверстия на поверхности PEI.
:::

# Как это работает
* При столкновении сопла или стола, которые приводят к остановке движения, данные измерений BD-сенсора также перестают изменяться, после чего BD-сенсор быстро отправляет сигнал остановки.
* Процесс автокалибровки z_offset во время выполнения G28: он может быть запущен, когда сопло при возврате в ноль контактирует со столом — затем сопло медленно поднимается до тех пор, пока оно не покинет поверхность стола — и эта позиция устанавливается как 0 для оси Z.

# Преимущества
* Автоматическая калибровка z_offset.
* Вы все еще можете вручную скорректировать z_offset для разных видов нитей.
* Компенсация температурного дрейфа.
* Температурный дрейф изменяет z_offset, но не меняет диапазон карты высоты стола с BD-сенсором. Это означает, что даже при разной температуре карта стола остается одинаковой.

# Как использовать

* Добавьте `collision_homing` и `collision_calibrate` в раздел [BDsensor].
``` bash
[BDsensor] 
collision_homing:0 # Установите в 1 для включения возврата с датчиком столкновения с соплом. Отключите, установив 0. Включение с датчиком столкновения с соплом. Отключение с помощью установки значения 0.
                   
collision_calibrate:0 # Установите в 1 для включения автокалибровки BD-сенсора с датчиком столкновения с соплом. Отключите, установив 0. # Включение автокалибровки BD-сенсора с датчиком столкновения с соплом. Отключение с помощью установки значения 0.
# Это означает, что вам не нужно вручную перемещать сопло по столу и проводить тест с бумагой перед отправкой команды калибровки M102 S-6.
```

* Чувствительность зависит от скорости; чем медленнее скорость, тем выше чувствительность, поэтому вам нужно отрегулировать скорость Z-оси, скорость возврата домой (homing_speed) и вторичную скорость возврата домой (second_homing_speed), которые должны находиться в диапазоне от 2 до 5.

:::info
Сопло должно быть очищено или нагрето для размягчения остатков нити.
Не устанавливайте скорость слишком высокой или слишком низкой. Если скорость слишком высокая, это может повредить вашу горячую часть или стол; если слишком низкая, то срабатывание произойдет в воздухе, хотя фактически сопло не касается стола.
:::

# Пример конфигурации
``` bash
[stepper_z]
endstop_pin: probe:z_virtual_endstop
#position_endstop: 0.0
position_max: 250
homing_speed: 5
second_homing_speed:3
homing_retract_dist:5
homing_retract_speed:2
```

:::tip Подсказка
`z_hop` (высота подъема Z) и `homing_retract_dist` (дистанция отката при возврате домой) должны быть больше или равны 5.
:::
# Пример конфигурации

```bash
[safe_z_home]
z_hop: 5 

[stepper_z]
homing_retract_dist:5
```
```bash
[BDsensor] 
...
speed:3 # Этот параметр применяется только для Z-наклона и команды PROBE_ACCURACY. # Этот параметр применяется только для Z-наклона и команды PROBE_ACCURACY.
...

```
:::tip Подсказка
Для справки используйте параметр `zero_reference_position`.
:::

``` bash
[bed_mesh]
horizontal_move_z:1 # Рекомендуется использовать значение от 0.7 до 1.0 мм.
zero_reference_position: 150, 160 # Установите это значение таким же, как home_xy_position в секции safe_z_home.
....
```

# Тестирование возврата домой
Отправьте примерно 10 команд `G28 Z`, затем проверьте стабильность выводимых данных в консоли после каждой отправки команды `G28 Z`.
``` bash
G28 Z
```
<Button variant="contained" disableElevation href="https://www.youtube.com/watch?v=RuPoXbrSPDc">Видео демонстрации</Button>
