---
sidebar_position: 4
---

# Возобновление печати после отключения питания в Klipper

## Обзор

- Возобновление печати после отключения питания в Klipper означает, что после повторного подключения питания Klipper автоматически восстанавливает состояние печати.
- Эта функция требует использования модуля безопасного выключения.
- Не применимо для моделей принтеров, где после отключения питания происходит смещение по оси Z.

## Настройка

### Конфигурационный файл plr.cfg

- В разделе настроек принтера создайте новый конфигурационный файл, назовите его `plr.cfg`.
- Содержимое файла должно быть следующим:

    ```cfg
    [power_loss_resume]
    # power_pin: PA0 # Управляющий вывод модуля безопасного выключения, подключенный к выводу PA0 нижнего устройства
    power_pin: host:gpiochip1/gpio21 # Управляющий вывод модуля безопасного выключения, подключенный к выводу PA21 верхнего устройства
    is_shutdown: True # Выполнять ли операцию выключения, по умолчанию включено
    start_gcode:
        # G-коды, выполняемые перед возобновлением печати
        # Все параметры, сохраненные до отключения питания, могут быть получены через {PLR}
        # Используйте M118 {PLR} для вывода всех доступных параметров
        M118 Начало возобновления печати: {PLR.print_stats.filename}
        M118 Точка прерывания: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; Установка температуры нагревательной пластины
        M104 S{PLR.extruder.target-10}  ; Установка температуры сопла
        M109 S{PLR.extruder.target-10}  ; Ожидание, пока сопло нагреется до заданной температуры
        G91                             ; Относительные координаты
        G1 Z2 F100                      ; Поднятие Z, подготовка к обнулянию X и Y
        G90                             ; Абсолютные координаты
        G28 X Y                         ; Обнуление X и Y
        M140 S{PLR.bed.target}          ; Установка температуры нагревательной пластины
        M104 S{PLR.extruder.target}     ; Установка температуры сопла
        M190 S{PLR.bed.target}          ; Ожидание, пока нагревательная пластина нагреется до заданной температуры
        M109 S{PLR.extruder.target}     ; Ожидание, пока сопло нагреется до заданной температуры
        M83                             ; Относительное экструзионирование
        # G1 E0.5 F400                  ; Экструзия небольшого количества материала
    layer_count: 2 # Возобновление печати после заданного числа слоев выполнит g-код layer_change_gcode
    layer_change_gcode:                
        # G-коды, выполняемые после возобновления печати заданного числа слоев
        M118 Восстановление скорости печати
        M106 S{PLR.fan_speed}             ; Включение вентилятора для подачи воздуха
        M220 S{PLR.move_speed_percent}    ; Установка процентной скорости движения
        M221 S{PLR.extrude_speed_percent} ; Установка процентной скорости экструзии
    shutdown_gcode:
        # G-коды, выполняемые перед выключением питания
        M118 Низкое напряжение питания, выключение
        # M112 ; Экстренная остановка

    ```

    :::warning Внимание

    - Макрос `start_gcode` в вышеуказанном конфигурационном файле может потребовать изменения в зависимости от конкретной модели принтера.

    :::

- Сохраните указанный выше конфигурационный файл.
- Откройте файл `printer.cfg` и добавьте следующую строку в начало файла:

    ```cfg

    [include plr.cfg]

    ```

- Нажмите кнопку "Сохранить" в правом верхнем углу и перезапустите систему.
- Теперь функция возобновления печати после отключения питания в Klipper настроена.

## Тестирование

- Печатайте любой файл. В процессе печати нажмите кнопку "Экстренная остановка", чтобы смоделировать отключение питания.
- Затем нажмите кнопку "Перезагрузка прошивки" и дождитесь нормального подключения Klipper.
- Если на веб-странице или в KlipperScreen появится всплывающее окно, это означает, что функция возобновления печати работает корректно.
- Далее можно провести тестирование в реальных условиях отключения питания.