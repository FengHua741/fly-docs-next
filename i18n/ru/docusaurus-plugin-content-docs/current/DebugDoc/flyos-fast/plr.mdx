---
sidebar_position: 4
---

# Возобновление печати после отключения питания в Klipper

## Общие сведения

- Возобновление печати после отключения питания в Klipper означает, что после восстановления питания система автоматически возобновляет состояние печати.
- Для использования этой функции необходим модуль безопасного выключения.
- Не применяется для устройств, где при отключении питания ось Z смещается.

## Настройка

### Конфигурационный файл plr.cfg

- В разделе настроек принтера создайте новый конфигурационный файл и назовите его `plr.cfg`.
- Содержимое файла должно быть следующим:

    ```cfg
    [power_loss_resume]
    # power_pin: PA0 # вывод для управления питанием модуля безопасного выключения, подключен к выводу PA0 нижнего контроллера
    power_pin: host:gpiochip1/gpio21 # вывод для управления питанием модуля безопасного выключения, подключен к выводу PA21 верхнего контроллера
    is_shutdown: True # выполняется ли операция выключения, по умолчанию включено
    paused_recover_z: -2.0 # если печать была приостановлена при отключении питания, перемещение Z при возобновлении печати, по умолчанию не производится
    start_gcode:
        # G-code, выполняемый перед возобновлением печати
        # Все сохраненные параметры до отключения питания доступны через {PLR}
        # Для вывода всех доступных параметров используйте M118 {PLR}
        M118 Начало возобновления печати: {PLR.print_stats.filename}
        M118 Точка прерывания: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; Установка температуры стола
        M104 S{PLR.extruder.target-10}  ; Установка температуры сопла
        M109 S{PLR.extruder.target-10}  ; Ожидание достижения температуры сопла
        G91                             ; Относительная координата
        G1 Z2 F100                      ; Поднятие Z, подготовка к сбросу X,Y
        G90                             ; Абсолютная координата
        G28 X Y                         ; Сброс координат X,Y
        M140 S{PLR.bed.target}          ; Установка температуры стола
        M104 S{PLR.extruder.target}     ; Установка температуры сопла
        M190 S{PLR.bed.target}          ; Ожидание достижения температуры стола
        M109 S{PLR.extruder.target}     ; Ожидание достижения температуры сопла
        M83                             ; Относительное экструзионирование
        # G1 E0.5 F400                  ; Экструзия небольшого количества материала
    layer_count: 2 # Количество слоев для возобновления печати перед выполнением layer_change_gcode
    layer_change_gcode:                
        # G-code, выполняемый после возобновления печати заданного количества слоев
        M118 Восстановление скорости печати
        M106 S{PLR.fan_speed}             ; Включение вентилятора
        M220 S{PLR.move_speed_percent}    ; Установка процентной скорости движения
        M221 S{PLR.extrude_speed_percent} ; Установка процентной скорости экструзии
    shutdown_gcode:
        # G-code, выполняемый перед выключением
        M118 Низкое напряжение питания, выключение
        # M112 ; Срочная остановка

    ```

    :::предупреждение Внимание

    - Конфигурационный файл выше может требовать корректировки в зависимости от конкретной модели принтера.

    :::

- После сохранения конфигурационного файла откройте файл `printer.cfg` и добавьте в начало следующую строку:

    ```cfg

    [include plr.cfg]

    ```

- Нажмите кнопку "Сохранить" в правом верхнем углу и перезагрузите систему.
- Таким образом, функция возобновления печати после отключения питания в Klipper будет настроена.

## Тестирование

- Начните печать любого файла и во время печати нажмите кнопку "Экстренная остановка", чтобы имитировать отключение питания.
- После этого нажмите "Перезагрузить фиксированную часть".
- Если на веб-интерфейсе или в KlipperScreen появляется всплывающее окно, это означает, что функция возобновления печати работает корректно.
- Далее можно провести тестирование реального отключения питания.
